description = "執行 AI Code Review，依據審核規範分析 git diff 變更"

git_diff = "git diff origin/master...HEAD -- . ':(exclude)package-lock.json' ':(exclude)composer.lock' ':(exclude)*.lock'"
current_time = "date '+%Y-%m-%d %H:%M'"
project_name = "basename $PWD"

prompt = """
# ============================================
# 行為約束（客製化需求）
# ============================================
behavior_constraints:
  禁止事項:
    - "禁止提出反問或請求補充資訊"
    - "禁止推理過程說明"
    - "禁止前言、結語、建議性寒暄"
    - "禁止假設未變更的程式碼"

  審查範圍:
    rule: "只評論「git diff 中實際出現的內容」"

  忽略項目:
    description: "以下項目假設已由 linter/IDE/CI 處理，不需審查"
    items:
      - "縮排、空格、空行、大括弧位置"
      - "檔案編碼與換行符號"
      - "純語法錯誤"

# ============================================
# 技能載入
# ============================================

## 必須載入的 Skills
以下 Skill 為本指令的核心依賴，**必須在審查前載入**：

| Skill              | 用途                                       |
|--------------------|--------------------------------------------|
| critical-thinking  | 提供多元視角、假設檢驗、邏輯分析的思考框架 |

## 動態技能載入規則
在「初步掃描」階段完成後，根據變更內容判斷是否需要額外載入以下 Skills：

| 偵測條件                                      | 載入 Skill             |
|----------------------------------------------|------------------------|
| 涉及 SQL/Eloquent/Repository/Migration       | database-architect     |
| 涉及 Redis/Cache/Session/Queue               | redis-architect        |
| 涉及認證/授權/Token/密碼/敏感資料             | security-auditor       |
| 涉及 Controller/Route/API 端點               | api-designer           |
| 涉及大量迴圈/批次處理/分頁/效能敏感操作       | performance-analyst    |
| 涉及 Laravel 特定功能 (Middleware/Event/Job) | laravel-expert         |
| 涉及 Test/PHPUnit/Feature Test               | qa-tester              |

# ============================================
# 審核流程
# ============================================

## ⚠️ 強制程式碼新鮮度驗證（Critical）
# 執行 code review 前，必須遵守以下規則：
# 1. **禁止依賴記憶**：不得使用對話歷史中「曾經看過的程式碼」進行審查
# 2. **強制重新讀取**：必須從本次 git diff 輸出或使用 read_file 工具重新讀取變更檔案
# 3. **驗證時效性**：若對話中曾討論過同一檔案，仍必須重新讀取最新版本
# 4. **明確引用來源**：審查意見必須引用「本次 git diff 中的實際行號與程式碼片段」

review_process:
  0_freshness_verification:
    description: "程式碼新鮮度驗證（必須執行）"
    critical: true
    actions:
      - "確認本次 git diff 輸出已載入"
      - "若需查看完整檔案上下文，使用 read_file 工具重新讀取"
      - "禁止引用對話歷史中記憶的舊版程式碼"
      - "所有審查意見必須基於本次 diff 中的實際內容"

  1_initial_scan:
    description: "初步掃描變更內容並決定動態載入技能"
    actions:
      - "識別變更檔案類型與數量"
      - "判斷變更類型（新功能/修復/重構）"
      - "評估影響範圍"
      - "根據上述動態技能載入規則，決定額外載入哪些 Skills"


  2_detailed_review:
    description: "詳細審核各項目（參考對應 Skill）"
    categories:
      - name: "SOLID 原則"
        weight: 25
        skill: "architecture-reviewer"
      - name: "程式碼品質"
        weight: 20
        skill: null
      - name: "Coding Style"
        weight: 15
        skill: "laravel-coding-standard"
      - name: "功能正確性"
        weight: 15
        skill: null
      - name: "安全性"
        weight: 15
        skill: "security-auditor"
      - name: "效能"
        weight: 5
        skill: "performance-analyst"
      - name: "可測試性"
        weight: 5
        skill: null

  3_scoring:
    description: "評分與產出報告"
    actions:
      - "計算各類別得分"
      - "產出問題清單"
      - "撰寫審查意見"

# ============================================
# 程式碼品質檢查 (權重 20%)
# ============================================
code_quality:
  weight: 20

  naming:
    rules:
      - "class: PascalCase，名詞"
      - "method: camelCase，動詞開頭"
      - "variable: camelCase，有意義的名稱"
      - "constant: UPPER_SNAKE_CASE"
    red_flags:
      - "單字母變數（迴圈索引除外）"
      - "縮寫不明確"
      - "名稱與實際行為不符"

  complexity:
    thresholds:
      cyclomatic_complexity: 10
      method_lines: 50
      class_lines: 500
      parameters: 5
      nesting_depth: 4

  duplication:
    threshold: "3 處以上相似程式碼需提取"

# ============================================
# Coding Style 檢查 (權重 15%)
# ============================================
coding_style:
  weight: 15

  naming:
    variable:
      rule: "小駝峰"
      correct: "$userEmail"
      incorrect: "$user_email"
    constant:
      rule: "全大寫+底線"
      correct: "COMPANY_IP"
      incorrect: "CompanyIp"
    class:
      rule: "大駝峰"
      correct: "MemberController"
      incorrect: "member_controller"
    interface:
      rule: "I 開頭"
      correct: "IGame"
      incorrect: "GameInterface"

  array_format:
    declaration:
      correct: "$array = [];"
      incorrect: "$array = array();"

  braces:
    function:
      rule: "大括弧換行"
    control_structure:
      rule: "大括弧不換行"

  cache_key:
    format: "前綴_描述:變數"
    correct:
      - "user_profile:123"
      - "game_code:1:2345"

  validation:
    rule: "使用陣列格式"

  api_design:
    http_methods:
      GET: "取得資料"
      POST: "新增資料"
      PUT: "修改資料"
      DELETE: "刪除資料"
    parameter_rule: "參數在 Body，不在 URL"

# ============================================
# 功能正確性檢查 (權重 15%)
# ============================================
correctness:
  weight: 15

  checks:
    - "業務邏輯是否符合需求規格"
    - "null/空陣列/空字串/極端值處理"
    - "例外是否適當捕獲"
    - "錯誤訊息是否有意義"
    - "競爭條件與死鎖風險"
    - "交易範圍與回滾機制"

# ============================================
# 可測試性檢查 (權重 5%)
# ============================================
testability:
  weight: 5

  checks:
    - "是否有對應的單元測試"
    - "依賴是否可被 mock"
    - "邊界條件是否覆蓋"
    - "是否測試異常情況"

# ============================================
# 輸出格式（必須嚴格遵循）
# ============================================
# 以下 MCP 操作為可選，若 MCP 不可用或發生錯誤，直接將報告輸出至對話中。

請嘗試將報告寫入到 GitHub 儲存庫（GitHub repo MCP） `changgenglu/changgenglu-blog` 的 `code-review/` 目錄中。
**若 MCP 不可用或發生錯誤，跳過儲存庫寫入，直接在對話中輸出完整報告。**

GitHub repo MCP 指南：
1. 首先使用 `get_file_contents` 檢查是否存在同名檔案。
2. 使用 `create_or_update_file` 工具。
3. 參數設定：
   - `owner`: "changgenglu"
   - `repo`: "changgenglu-blog"
   - `path`: "code-review/<filename>"
   - `content`: <content>
   - `message`: "docs: cr report: <filename>" 或 "docs: update cr report: <filename>"（若為更新）
   - `branch`: "master" (或預設分支)
   - `sha`: 若為更新現有檔案，需提供原檔案的 SHA
4. 完成後回報寫入的檔案路徑與狀態。

**filename 命名規則**：
- 使用 {{project_name}} + 分支名稱作為檔案名稱（不含時間戳或流水號）
- 範例：`{{project_name}}` + 分支 `feature-inbox` → `{{project_name}}-feature-inbox.md`

**文件更新邏輯**：
- 若已存在同名檔案，則更新該檔案內容，並在版本記錄區塊新增一筆記錄
- 新建檔案時，版本記錄從 v1.0 開始；更新時遞增版本號（如 v1.1, v1.2...）

請依照以下 Markdown 模板輸出，禁止新增或刪減區塊：

```markdown
# <filename>

## 版本記錄

| 版本 | 更新時間 | 變更摘要 |
|------|---------|----------|
| v1.0 | {{current_time}} | 初次審查 |

---

## 變更摘要

| 項目 | 內容 |
|-----|-----|
| 變更檔案數 | N 個 |
| 變更類型 | 新功能 / 修復 / 重構 |
| 影響範圍 | 簡述影響模組 |

---

## 問題清單

### 🔴 嚴重（必須修復）
| 檔案:行號 | 問題描述 | 建議修復 |
|----------|---------|---------| 
| `path/file.php:123` | SQL Injection 風險 | 使用 Eloquent 或參數化查詢 |

### 🟡 警告（建議修復）
| 檔案:行號 | 問題描述 | 建議修復 |
|----------|---------|---------| 
| `path/file.php:45` | N+1 查詢問題 | 使用 with() 預載入 |

### 🔵 建議（可選修復）
| 檔案:行號 | 問題描述 | 建議修復 |
|----------|---------|---------| 
| `path/file.php:78` | 變數命名不符規範 | $user_data 改為 $userData |

---

## 審查結論

### 各類別評分

| 類別 | 權重 | 得分 | 狀態 | 說明 |
|-----|-----|-----|-----|-----|
| SOLID 原則 | 25% | 0-100 | ✅/⚠️/❌ | 簡述 |
| 程式碼品質 | 20% | 0-100 | ✅/⚠️/❌ | 簡述 |
| 功能正確性 | 15% | 0-100 | ✅/⚠️/❌ | 簡述 |
| 安全性 | 15% | 0-100 | ✅/⚠️/❌ | 簡述 |
| 多層架構 | 15% | 0-100 | ✅/⚠️/❌ | 簡述 |
| 效能 | 5% | 0-100 | ✅/⚠️/❌ | 簡述 |
| 可測試性 | 5% | 0-100 | ✅/⚠️/❌ | 簡述 |

### 總分計算

**加權總分**：XX / 100

### 合併判定

| 分數區間 | 判定 | 行動 |
|---------|-----|-----|
| 90-100 | ✅ 優秀 | 可直接合併 |
| 70-89 | ⚠️ 良好 | 修復警告後可合併 |
| 50-69 | ⚠️ 待改善 | 必須修復問題 |
| 0-49 | ❌ 拒絕 | 需重大修改 |

**最終結論**：✅ 可合併 / ⚠️ 修復後可合併 / ❌ 需重大修改
```

# ============================================
# 審查完成通知（LINE MCP - 當使用者要求）
# ============================================

若使用者要求發送通知，載入 `line-notifier` skill 並依據其規範發送通知。
使用「Code Review 完成」場景模板。

---

# ============================================
# 審查來源（擇一）
# ============================================

{{#if input}}
```diff
{{input}}
````

{{else}}

```diff
{{git_diff}}
```

{{/if}}
"""
