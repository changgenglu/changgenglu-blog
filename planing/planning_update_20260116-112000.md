# GTR 推播功能擴展 - 實作規劃

## 1. 需求概述

### 1.1 背景與目標
- 需求背景：現有的 GTR 推播服務僅支援維護狀態通知，當遊戲狀態或供應商白名單變更時，前端需依賴輪詢或重新載入，導致即時性不足。
- 功能目標：擴展 `Pusher` 服務，新增遊戲狀態、供應商狀態及地區白名單變更的即時推播事件。
- 影響範圍：`app/Http/Controllers/` 下的 6 個相關 Controller，涵蓋控端與管端業務。

### 1.2 範圍界定
- **包含**：`IPusher` 介面擴充、Controller 業務邏輯與推播整合、批次處理邏輯、非同步推播。
- **不包含**：Pusher Service 基礎設施修改、前端 UI 實作。
- **假設條件**：Redis GTR 連線 (`config/database.php`) 已配置正確且可用。

---

## 2. 系統架構變更

### 2.1 資料庫變更
#### 新增/修改資料表
| 資料表名稱 | 變更類型 | 說明 |
|-----------|---------|-----|
| N/A | N/A | 本次實作不涉及資料庫結構變更 |

### 2.2 設定變更
| 設定檔 | 變更內容 | 說明 |
|-------|---------|-----|
| `app/Interfaces/IPusher.php` | 新增事件常數 | 定義遊戲狀態、供應商、地區變更事件 |

### 2.3 程式碼結構
#### 修改檔案
| 檔案路徑 | 修改內容摘要 |
|---------|-------------|
| `app/Interfaces/IPusher.php` | 新增 `EVENT_GAME_STATUS_CHANGE` 等事件 |
| `app/Http/Controllers/GameStatusController.php` | 整合控端遊戲狀態變更推播 |
| `app/Http/Controllers/AgentGameStatusController.php` | 整合管端遊戲狀態變更推播 |
| `app/Http/Controllers/PlatformController.php` | 整合控端供應商狀態變更推播 |
| `app/Http/Controllers/AgentPlatformController.php` | 整合管端供應商狀態變更推播 |
| `app/Http/Controllers/PlatformCountryController.php` | 整合地區白名單變更推播 |

---

## 3. API 規格設計

### 3.1 端點總覽 (部分舉例)
| Method | Path | 說明 | 權限 |
|--------|------|-----|-----|
| POST | `/api/admin/games/status/release` | 遊戲上架並推播 | admin |
| POST | `/api/agent/games/status/disable` | 平台停用遊戲並推播 | agent |

### 3.2 詳細規格 (以遊戲狀態為例)

#### [POST] /api/admin/games/status/release
**說明**：將指定遊戲設為上架狀態並廣播推播。

**Request**
```json
{
  "id": "integer | required | 遊戲ID"
}
```

**Response - Success (200)**
```json
{
  "data": {
    "id": 123,
    "enable": 1,
    "code": "G001"
  }
}
```

### 3.3 權限設計
| 操作 | 允許角色 | 特殊條件 |
|-----|---------|---------|
| 控端操作 | admin | 全域廣播 (publish) |
| 管端操作 | agent, operator | 指定平台推播 (publishProvider) |

---

## 4. 實作細節

### 4.1 實作任務清單
| # | 任務 | 依賴 |
|---|-----|-----|
| 1 | 修改 `IPusher` 介面常數 | - |
| 2 | 在 `GameStatusController` 注入推播邏輯 | 1 |
| 3 | 在 `AgentGameStatusController` 注入推播邏輯 (需 client_id) | 1 |
| 4 | 在 `PlatformController` 注入供應商推播 | 1 |
| 5 | 在 `PlatformCountryController` 注入地區推播 | 1 |
| 6 | 執行代碼風格檢查 (`pint`) | 2,3,4,5 |

### 4.2 關鍵邏輯

#### Service 核心邏輯
```pseudo
class ControllerMethod:
    function execute(request):
        DB::transaction:
            // 執行 DB 異動
            result = updateModel(request)
            
        // 事務成功後發送推播
        if result.success:
            try:
                pusher.publish(CHANNEL, EVENT, payload)
            catch error:
                Log::error("Pusher fail", error)
        
        return response(result)
```

### 4.3 錯誤處理設計
| Exception | 錯誤碼 | 觸發條件 |
|-----------|-------|---------|
| PusherException | pusher_connection_failed | Redis 連線超時或失敗 |

---

## 5. 部署與驗證

### 5.1 部署注意事項
| 階段 | 項目 | 說明 |
|-----|-----|-----|
| 部署中 | Config | 確認 .env 中 REDIS_GTR 相關設定已就緒 |
| 部署後 | Monitor | 使用 redis-cli MONITOR 監控發送頻率 |

### 5.2 驗證項目
#### 整合測試
| 測試類別 | 測試情境 | 預期結果 |
|---------|---------|---------|
| RedisTest | 監聽 game 頻道 | 收到對應 JSON Payload |

---
