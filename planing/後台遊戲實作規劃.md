## 實作規劃摘要：Eagle 遊戲管理系統 (修正版)

此摘要旨在為 AI Model Agent 提供清晰的實作指引，確保 `eagle` 專案的遊戲管理功能（包含系統級與租戶級）按照先前討論的決策進行，並**嚴格遵循「Admin 顯式分配遊戲給租戶」的模式**。

### 1. 核心關係：`Game` 與 `TenantGame`

*   **`Game` (系統級遊戲)**：代表平台上的所有遊戲基本資訊，由系統管理員維護。它是所有遊戲的「源頭資料」。
    *   **屬性**：遊戲名稱、代碼、所屬平台、系統分類、RTP、圖片路徑、系統狀態（啟用/維護）、發佈時間等。
    *   **無 `vip_level` 欄位**：`Game` 模型本身不包含 `vip_level` 欄位。
    *   **無客端分類與自訂圖片/維護**：`Game` 不區分客端分類，也不提供租戶自訂圖片或維護時間的欄位。
    *   **關聯**：一個 `Game` 可關聯多個 `TenantGame` 紀錄。

*   **`TenantGame` (租戶級遊戲配置)**：代表某個特定租戶針對某款 `Game` 的客製化配置。這是租戶與遊戲互動的「中間層」，由租戶管理員維護。
    *   **屬性**：`tenant_id`, `game_id`, `enabled` (租戶啟用狀態), `vip_level` (租戶對該遊戲設定的 VIP 門檻), `published_at` (租戶發佈時間)。
    *   **複合主鍵**：(`tenant_id`, `game_id`)。
    *   **客製化受限**：**不包含**租戶自訂的圖片路徑、客端分類、維護時間等欄位。這些功能均沿用 `Game` 的設定或由獨立模組管理。

### 2. `TenantGame` 的資料流與生命週期 (修正版)

`TenantGame` 的資料流動與生命週期將從「Admin 顯式分配」的角度來管理。

#### 2.1 資料流動 (Data Flow)

*   **創建 `Game` (Admin 動作)**:
    1.  **動作**：系統管理員（Admin）透過 `GameController` 呼叫 `IGameService::createGame` 新增一個新的 `Game` 紀錄。
    2.  **觸發**：此動作**僅**在 `Game` 資料表新增一筆紀錄，並建立多國語系 (`GameLanguage`)。
    3.  **結果**：**此時不會自動創建任何 `TenantGame` 紀錄**。

*   **分配遊戲 (Admin 動作 - 新增功能)**:
    1.  **動作**：系統管理員（Admin）透過一個新的 API/功能，選擇一個或多個 `Tenant`，並指定一組或多組 `Game`。
    2.  **觸發**：此動作將呼叫 `ITenantGameService` (或新的服務方法) 來建立 `TenantGame` 紀錄。
    3.  **結果**：為每個選定的 `Tenant` 和 `Game` 組合，創建一筆 `TenantGame` 紀錄。
        *   `vip_level`：在此分配操作中設定，可作為請求參數或由系統提供預設值。
        *   `enabled`：預設為 `false` (未上架)。
        *   `published_at`：預設為 `null`。

*   **修改 (Modification)**:
    1.  **Admin 對 `Game` 的修改**：當 Admin 修改 `Game` 的核心屬性 (例如名稱、平台、系統狀態) 時，`TenantGame` 紀錄本身不會直接被修改，但由於 `TenantGame` 是關聯 `Game` 的，因此租戶端看到的遊戲基礎資訊會隨之更新。
    2.  **Agent 對 `TenantGame` 的修改**：租戶 (Agent) 透過 `TenantGameController` 呼叫 `ITenantGameService::updateGameConfig` 或其他方法，可以修改 `TenantGame` 的 `enabled` 狀態。
        *   **VIP 等級限制**：**嚴格禁止**租戶修改 `TenantGame.vip_level`。控制器層應忽略此類請求或拋出錯誤。
        *   **圖片/分類/維護限制**：**不提供**租戶修改遊戲圖片、客端分類或自訂維護時間的功能。

*   **刪除 (Deletion)**:
    1.  **Admin 刪除 `Game`**：當 Admin 刪除一個 `Game` 紀錄時，所有與該 `Game` 關聯的 `TenantGame` 紀錄將會被**連帶刪除 (物理刪除)**。
    2.  **Agent「移除」遊戲 (解除分配)**：當租戶（Agent）透過其介面「移除」某款遊戲時，對應的 `TenantGame` 紀錄將會被**物理刪除** (等同於解除該遊戲的分配)。

#### 2.2 生命週期 (Lifecycle)

1.  **誕生 (Assignment)**：`TenantGame` 紀錄在 Admin 「分配遊戲」給特定租戶時誕生。初始狀態為**未上架 (`enabled = false`, `published_at = null`)**。
2.  **活躍 (Activation)**：租戶可以將 `TenantGame` 紀錄從「未上架」變更為「上架」。
    *   「上架」操作會將 `TenantGame.enabled` 設為 `true`，並將 `TenantGame.published_at` 設定為當前時間。
    *   遊戲在前端是否對會員顯示，取決於 `TenantGame.enabled = true` 且 `TenantGame.published_at` 應為過去時間，同時考量系統級的 `Game.status` 和 `Game` 的維護狀態。
3.  **停用/下架 (Deactivation)**：租戶可以將 `TenantGame` 紀錄從「上架」變更為「停用」。
    *   「停用」操作會將 `TenantGame.enabled` 設為 `false`。
4.  **終結 (Termination)**：
    *   租戶「移除」遊戲時，對應的 `TenantGame` 紀錄會被**物理刪除**。
    *   Admin 刪除 `Game` 時，所有關聯的 `TenantGame` 紀錄會被**物理刪除**。

### 3. 實作要求與注意事項 (給 AI Agent)

在實作時，AI Agent **必須嚴格遵守**以下原則：

1.  **欄位不變更**：`Game` 和 `TenantGame` 模型現有欄位結構**不得新增或修改**，特別是**不要在 `Game` 模型中增加 `vip_level` 欄位**。
2.  **Admin `Game` 創建**：
    *   `IGameService::createGame` 不再包含自動建立 `TenantGame` 的邏輯。
    *   `GameController::create` 請求中的 `vip_level` 參數，在創建 `Game` 時無需寫入 `Game` 模型，該參數應在後續的「分配遊戲」功能中使用。
3.  **Admin 「分配遊戲」功能 (新增)**：
    *   **新增 API/Controller**：需新增一個 Admin 端的 API 路由（例如 `/api/admin/games/assign`）及其對應的 Controller 方法。此功能用於將特定遊戲分配給特定租戶。
    *   **服務層邏輯**：該 API 將呼叫 `ITenantGameService` (或新增的服務方法 `assignGamesToTenant`)，接收 `tenant_id` 和 `game_ids` 列表，並負責 `upsert` 或創建 `TenantGame` 紀錄。
    *   **VIP 等級設定**：`vip_level` 應在此「分配遊戲」功能中設定，作為請求參數或系統預設值寫入 `TenantGame`。
4.  **`TenantGame` 的 CRUD 實作 (Agent 視角)**：
    *   **「上架」邏輯**：實現 `ITenantGameService::releaseGame`，確保在 `TenantGame.enabled` 設為 `true` 的同時，將 `TenantGame.published_at` 更新為 `now()`。
    *   **「移除」邏輯**：實現 `ITenantGameService::removeGame`，執行**物理刪除** `tenant_games` 表中的紀錄。
    *   **「修改配置」限制**：`ITenantGameService::updateGameConfig` 和 `TenantGameController` 必須包含邏輯，**禁止**修改 `vip_level` 欄位。當收到 `vip_level` 參數時，應**忽略**該參數或拋出**明確的錯誤**（例如 `ErrorCode::ACTION_NOT_ALLOWED`）。
5.  **快取管理**：所有對 `Game` 和 `TenantGame` 的寫操作都必須清除相關的快取，確保資料一致性。快取 Key 應包含 `tenant_id` 以便精確清除。
6.  **錯誤處理**：使用 `App\Enums\Common\ErrorCode` 定義的錯誤碼和訊息。

此規劃摘要將作為 AI Agent 實作 Eagle 遊戲管理系統的最終藍圖。