# 遊戲語系批次設置功能 - 實作規劃

## 版本記錄

| 版本 | 更新時間 | 變更摘要 |
|------|---------|----------|
| v1.0 | 2026-01-22 | 初次規劃：新增批次設置預設語系與支援語系功能 |
| v1.1 | 2026-01-22 | 規格調整：API 新增 `description` 參數 |

---

## 1. 需求概述

### 1.1 背景與目標
- **背景 (Why)**：目前系統管理員（Admin/Ctl）在調整多款遊戲的語系設定時，需逐一進入遊戲編輯頁面操作，效率較低。
- **目標 (What)**：於後台控端新增「批次語系設置」功能，允許選取多款遊戲後，一鍵更新其「預設語系」與「支援語系」。
- **影響範圍 (Where)**：Admin 後台遊戲管理模組、內部後端 API（Internal API）。

### 1.2 範圍界定
- **包含**：
    - 新增 batch update API 端點。
    - 實作參數驗證邏輯（驗證語系是否存在、預設語系是否在支援列表中）。
    - 代理調用內部服務（Internal Backend）執行資料庫更新。
    - 回傳操作前後的遊戲資訊比對。
- **不包含**：
    - 修改單一遊戲的詳細多語系名稱（Locales/Names）。
    - 遊戲內容本身的翻譯。
- **假設條件**：
    - 內部服務（Internal Backend）已具備或將同步實作對應的 `/api/backend/game/mult_languages` 介面。

---

## 2. 系統架構變更

### 2.1 資料庫變更
#### 修改資料表
本專案為 Gateway 層，資料庫更新由內部服務執行。對應內部服務的 `game` 表欄位預期如下：

| 資料表名稱 | 變更類型 | 說明 |
|-----------|---------|-----|
| `game` | 修改 | `default_lang`: 儲存預設語系代碼；`support_langs`: 以 JSON 儲存支援語系列表。 |

### 2.2 設定變更
N/A (語系定義參考 `App\Interfaces\ILanguage`)

### 2.3 程式碼結構
#### 修改檔案
| 檔案路徑 | 修改內容摘要 |
|---------|-------------|
| `routes/api.php` | 註冊 `PUT /game/multi_languages` 路由。 |
| `app/Http/Controllers/GameController.php` | 實作 `setMultiLanguages` 方法，處理參數驗證與內部 API 調用。 |

---

## 3. API 規格設計

### 3.1 端點總覽
| Method | Path | 說明 | 權限 |
|--------|------|-----|-----|
| PUT | `/api/game/multi_languages` | 批次設置遊戲語系 | `admin` (Ctl) |

### 3.2 詳細規格

#### [PUT] /api/game/multi_languages
**說明**：更新指定遊戲清單的預設語系及支援語系列表。

**Request**
```json
{
  "game_ids": "array | required | 遊戲 ID 列表",
  "default_lang": "string | required | 預設語系代碼 (如 en-us)",
  "support_langs": "array | required | 支援語系代碼列表",
  "description": "string | optional | 備註說明"
}
```

**Validation Rules**
| 欄位 | 規則 | 說明 |
|-----|-----|-----|
| game_ids | required, array | 至少需包含一個 ID |
| game_ids.* | integer | 必須為整數 |
| default_lang | required, string, in:ILanguage::LANGUAGE_LIST | 必須在系統支援的語系清單中 |
| support_langs | required, array | 支援語系清單 |
| support_langs.* | string, in:ILanguage::LANGUAGE_LIST | 列表項目必須為有效語系 |
| description | nullable, string, max:200 | 備註說明 (長度限制參考專案慣例) |

**Business Validation**
- `default_lang` 必須包含在 `support_langs` 陣列中。

**Response - Success (200)**
```json
{
  "before": [ { "id": 1, "name": "Game A", "default_lang": "zh-tw", ... } ],
  "after": [ { "id": 1, "name": "Game A", "default_lang": "en-us", ... } ]
}
```

---

## 4. 實作細節

### 4.1 實作任務清單

| # | 任務 | 依賴 |
|---|-----|-----|
| 1 | 在 `routes/api.php` 新增 `/game/multi_languages` 路由 | - |
| 2 | 在 `GameController` 新增 `setMultiLanguages` 方法 | 1 |
| 3 | 實作 Request 驗證邏輯，包含自定義 `default_lang` 存在於 `support_langs` 的檢查 | 2 |
| 4 | 實作「更新前」狀態抓取邏輯（調用內部 `/api/backend/game/list`） | 3 |
| 5 | 實作代理調用內部批次更新 API（調用內部 `/api/backend/game/mult_languages`） | 4 |
| 6 | 整合回傳資料並進行測試 | 5 |

### 4.2 關鍵邏輯（偽代碼）

#### GameController@setMultiLanguages

```php
public function setMultiLanguages(Request $request)
{
    $validated = $this->validate($request, [
        'game_ids' => [ 'required', 'array' ],
        'default_lang' => [ 'required', 'string', Rule::in(ILanguage::LANGUAGE_LIST) ],
        'support_langs' => [ 'required', 'array' ],
        'support_langs.*' => [ 'string', Rule::in(ILanguage::LANGUAGE_LIST) ],
        'description' => [ 'nullable', 'string', 'max:200' ],
    ]);

    // 額外驗證：預設語系必須在支援語系中
    if (!in_array($validated['default_lang'], $validated['support_langs'])) {
        throw new \App\Exceptions\RuntimeException('default_lang_must_be_in_support_langs');
    }

    $operator = app('Backend')::user();
    if (!app('Service')::init('User')::isCtl($operator)) {
        throw new \App\Exceptions\PermissionException('permission_denied');
    }

    // 1. 取得更新前狀態
    $gamesBefore = HttpClient::get(app('Service')::init('Internal')::generateApiUrl('/api/backend/game/list'), [
        'data' => [ 'ids' => $validated['game_ids'], 'limit' => 999 ]
    ]);

    // 2. 調用內部服務執行批次更新
    $response = HttpClient::put(app('Service')::init('Internal')::generateApiUrl('/api/backend/game/mult_languages'), [
        'data' => $validated
    ]);

    return [
        'before' => $gamesBefore->json(),
        'after' => $response->json(),
    ];
}
```

---

## 5. 部署與驗證

### 5.1 部署注意事項
| 階段 | 項目 | 說明 |
|-----|-----|-----|
| 部署前 | 內部連動 | 必須確保內部服務 (Internal Backend) 的 `/api/backend/game/mult_languages` 介面已部署 |
| 部署中 | Config | 無特殊環境變數 |
| 部署後 | 權限 | 確認該 API 已正確配置於 Admin (Ctl) 的權限白名單中 |

### 5.2 驗證項目
#### 單元測試
| 測試類別 | 測試項目 | 預期結果 |
|---------|---------|---------|
| ControllerTest | 傳入無效語系代碼 | HTTP 400 |
| ControllerTest | `default_lang` 不在 `support_langs` 內 | 拋出 RuntimeException |
| ControllerTest | 傳入超長 `description` | HTTP 400 |

#### 整合測試
| 測試類別 | 測試情境 | 預期結果 |
|---------|---------|---------|
| ControllerTest | API 正常呼叫 | HTTP 200, 回傳正確 before/after |
| ControllerTest | 非 Admin 角色調用 | HTTP 403 |

### 5.3 自我檢查點

#### 基本規範
- [x] 符合專案 Gateway 代理模式
- [x] 使用 `ILanguage` 介面進行語系合法性檢查
- [x] 參考 `GameMaintainController@setMultiMaintain` 的實作慣例
