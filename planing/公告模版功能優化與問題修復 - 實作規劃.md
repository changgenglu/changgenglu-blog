# 公告模版功能優化與問題修復 - 實作規劃

## 版本記錄（2026-01-19 18:30）

| 版本 | 更新時間 | 變更摘要 |
|------|---------|----------|
| v1.0 | 2026-01-19 18:30 | 基於 Code Review 報告 (2026-01-19) 擬定之優化規劃，排除架構重構類項目 |

---

## 1. 需求概述

### 1.1 背景與目標
- **需求背景**：根據 `code-review/feature-announcement-templates Code Re.md` 審查報告，`feature-announcement-templates` 分支存在多項程式碼品質、功能正確性、安全性與效能問題。
- **功能目標**：針對非架構重構類的具體問題進行修復與優化，確保程式碼運作穩定、安全且符合基本效能標準。
- **影響範圍**：
  - `app/Http/Controllers/AnnouncementTemplateController.php`
  - `app/Models/AnnouncementTemplate.php`
  - `app/Services/AnnouncementTemplate.php`

### 1.2 範圍界定
- **包含**：
  - 修正 Model `fillable` 與 `guarded` 設定衝突。
  - 修正 Service `checkType` 邊界檢查錯誤。
  - 增強 API 輸入參數 `type` 與 `sub_type` 的驗證規則（安全性）。
  - 優化 Controller 建立後的重複查詢（效能）。
  - 優化 Service 列表查詢的 N+1 問題（效能）。
  - 修正 Namespace Import 順序與移除未使用類別（代碼品質）。
  - 補足程式碼排版（空行）。
- **不包含**（依據指示排除）：
  - 違反 SRP 原則的重構（Controller 業務邏輯下沉）。
  - 違反 DRY 原則的重構（Backend/Agent 重複代碼）。
  - 方法過長的拆分。
  - 依賴注入（Dependency Injection）重構（維持現有 `app('Service')->init` 模式）。
- **假設條件**：
  - `IAnnouncement` 介面已定義正確的 `TYPE_LISTS` 與 `SUB_TYPES` 常數。

---

## 2. 系統架構變更

### 2.1 資料庫變更
*本次無資料庫 Schema 變更。*

### 2.2 設定變更
*本次無設定檔變更。*

### 2.3 程式碼結構

#### 修改檔案
| 檔案路徑 | 修改內容摘要 |
|---------|-------------|
| `app/Models/AnnouncementTemplate.php` | 移除 `$fillable` 中的 `id`，解決與 `$guarded` 的衝突。 |
| `app/Http/Controllers/AnnouncementTemplateController.php` | 1. 調整 `use` 順序與移除未使用 Import。<br>2. 增強 `validate` 規則（加入 `Rule::in`）。<br>3. 優化 `createBy...` 方法中的資料回傳邏輯（移除多餘查詢）。<br>4. 補足 return 前空行。 |
| `app/Services/AnnouncementTemplate.php` | 1. 修正 `checkType` 方法的 `isset` 檢查。<br>2. `lists` 方法增加 `with_contents` 選項以支援 Eager Loading。 |

---

## 3. API 規格設計

### 3.1 端點總覽
*API 路徑與權限維持不變，僅增強輸入驗證邏輯。*

### 3.2 詳細規格變更 (Validation Only)

#### [POST] /api/announcement-template (Create/Edit)

**Validation Rules Update**
| 欄位 | 原規則 | 新規則 | 說明 |
|-----|-------|-------|-----|
| type | `required, integer` | `required, integer, Rule::in(IAnnouncement::TYPE_LISTS)` | 限制僅能輸入合法的公告類型 |
| sub_type | `integer` | `integer, min:0` | 確保子類型非負數（具體範圍依賴業務邏輯，至少需非負） |

---

## 4. 實作細節

### 4.1 實作任務清單

| # | 任務 | 檔案 | 優先度 |
|---|-----|------|-------|
| 1 | 修正 Model `fillable` 設定衝突（移除 `id`） | `AnnouncementTemplate.php` | 高 |
| 2 | 修正 Service `checkType` 邊界錯誤（加入 `isset` 判斷） | `AnnouncementTemplate.php` (Service) | 高 |
| 3 | 增強 Controller 輸入驗證（`type` 範圍檢查） | `AnnouncementTemplateController.php` | 中 |
| 4 | 清理 Controller Import（順序調整、移除未使用） | `AnnouncementTemplateController.php` | 低 |
| 5 | 優化 Controller 建立後回傳邏輯（使用 `refresh` 或物件屬性，避免再次 DB 查詢） | `AnnouncementTemplateController.php` | 中 |
| 6 | 優化 Service `lists` 方法（加入 Eager Loading 支援避免 N+1） | `AnnouncementTemplate.php` (Service) | 中 |
| 7 | 補足 Controller 內 return 前的空行 | `AnnouncementTemplateController.php` | 低 |

### 4.2 關鍵邏輯（偽代碼）

#### 1. Service: checkType 修正
```php
public function checkType(int $type, int $subType): bool
{
    // Fix: Add boundary check
    if (! isset(IAnnouncement::SUB_TYPES[$type])) {
        return false;
    }

    $subTypeConstants = IAnnouncement::SUB_TYPES[$type];
    
    // ... existing logic ...
}
```

#### 2. Controller: Create 優化
```php
public function createByBackend(Request $request)
{
    // ... validation ...
    
    // Service 執行建立 (包含 Transaction)
    $template = $templateService->create($provider['id'], $validated);
    
    // ... upsert content ...
    
    // Fix: Remove duplicate query
    // Old: $template = $templateService->get(...); 
    // New: Use eager load or load missing if supported, or just verify structure
    $template->load('contents'); // Ensure contents are loaded efficiently
    
    return $template;
}
```

### 4.3 錯誤處理設計
- `ValidationException`: 當 `type` 超出範圍時，Laravel 自動拋出 422 錯誤。

---

## 5. 部署與驗證

### 5.1 部署注意事項
- 無特殊部署動作，僅需部署程式碼。

### 5.2 驗證項目

#### 單元/整合測試
| 測試情境 | 預期結果 | 關聯任務 |
|---------|---------|---------|
| 傳入無效的 `type` 值 (e.g. 999) | HTTP 422 Validation Error | Task 3 |
| 傳入不存在的 `type` 給 `checkType` | 回傳 `false`，不拋出 PHP Error | Task 2 |
| 建立模版後檢查 SQL Log | 確認無重複 `select * from announcement_templates where id = ?` | Task 5 |
| 列表查詢 (含 contents) | 確認 SQL 為 2 次查詢 (Template + Contents)，非 N+1 | Task 6 |

### 5.3 自我檢查點
- [ ] Model `$fillable` 不包含 `id`。
- [ ] `checkType` 傳入未知 key 不會報錯。
- [ ] Controller `use` 區塊無 unused import。
