# Eagle 遊戲管理系統實作規劃 (v2.0)

## 1. 概述 (Overview)

本文件為 Eagle 專案「遊戲管理系統」的完整實作指引。目標是將現有的遊戲管理功能重構為權限分明、邏輯清晰的 **Admin (系統管理員)** 與 **Agent (租戶/站長)** 雙層架構。

**核心原則**：
1.  **顯式分配 (Explicit Assignment)**：遊戲不會自動同步給租戶，必須由 Admin 顯式分配。
2.  **權限隔離**：Admin 負責管理遊戲本體與分配；Agent 負責管理已分配遊戲的上下架狀態。
3.  **VIP 設定後置**：`vip_level` 不在建立遊戲時設定，而是在 **分配遊戲給租戶時** 才定義。

---

## 2. 資料模型與關係 (Data Model)

### 2.1 `Game` (系統級遊戲)
*   **角色**：所有遊戲的源頭資料 (Master Data)。
*   **關鍵屬性**：名稱、代碼、平台、分類、RTP、圖片、系統狀態。
*   **限制**：**不包含** `vip_level`、`client_category`、租戶自訂圖片/維護時間。

### 2.2 `TenantGame` (租戶級遊戲配置)
*   **角色**：租戶與遊戲的關聯表 (Association Table)。
*   **關鍵屬性**：
    *   `tenant_id`, `game_id` (複合主鍵)
    *   `enabled`: 租戶端的上架開關。
    *   `vip_level`: **租戶專屬**的 VIP 門檻 (在此層級定義)。
    *   `published_at`: 租戶端的上架時間 (用於控制新遊戲顯示)。
*   **生命週期**：
    *   **誕生**：Admin 執行「分配」動作時建立。
    *   **活躍**：Agent 執行「上架」動作 (`enabled=true`, 更新 `published_at`)。
    *   **消滅**：Agent 執行「移除」動作 (物理刪除紀錄，解除分配)。

---

## 3. 功能實作細節 (Implementation Details)

### 3.1 Admin 端 (系統管理員)

**職責**：管理 `Game` 主檔、將遊戲分配給租戶。

#### A. 路由遷移與重構
*   將 `routes/api.php` 中原本的 `/games` 路由遷移至 `routes/api/admin.php`。
*   Namespace 建議：`App\Http\Controllers\Admin\GameController`。

#### B. 新增遊戲 (`create`)
*   **輸入**：遊戲基本資訊 (名稱、代碼、平台、RTP...)。
*   **邏輯**：僅在 `games` 資料表建立紀錄。
*   **注意**：請求參數中 **不應包含** `vip_level` (因為此時還沒分配給租戶)。若前端傳入，後端應忽略或移除。

#### C. 分配遊戲 (`assign`) - **核心新功能**
*   **路由**：建議新增 `POST /api/admin/games/assign` (或重構 `sync`)。
*   **輸入**：
    *   `tenant_ids`: 目標租戶 ID 列表 (Array)。
    *   `game_ids`: 要分配的遊戲 ID 列表 (Array)。
    *   `vip_level`: **(必填/選填)** 分配時設定的初始 VIP 門檻。
*   **邏輯**：
    1.  驗證 Tenant 與 Game 存在性。
    2.  對每個 (Tenant, Game) 組合執行 `upsert` 或 `create`：
        *   若紀錄不存在：建立新紀錄，寫入 `vip_level`，`enabled` 預設 `false`。
        *   若紀錄已存在：(可選) 更新 `vip_level` 或忽略。
    3.  清除相關租戶的遊戲列表快取。

### 3.2 Agent 端 (租戶/站長)

**職責**：管理已分配遊戲的狀態 (上下架)。

#### A. 路由遷移與重構
*   將 `routes/api.php` 中原本的 `/tenant/games` 路由遷移至 `routes/api/agent.php`。
*   Namespace 建議：`App\Http\Controllers\Agent\TenantGameController`。

#### B. 遊戲列表 (`list`)
*   **邏輯**：僅回傳 `tenant_games` 表中存在的遊戲 (即已分配的遊戲)。

#### C. 修改配置 (`updateConfig` / `batch-config`)
*   **用途**：執行「上架 (Release)」、「下架 (Disable)」操作。
*   **輸入**：`enabled` (Boolean)。
*   **邏輯**：
    *   更新 `enabled` 狀態。
    *   若 `enabled` 為 `true` (上架)，同時更新 `published_at` 為 `now()`。
*   **安全限制 (Critical)**：
    *   **嚴格禁止** 修改 `vip_level`。
    *   若請求包含 `vip_level`，必須 **過濾掉** 或 **拋出 `403 Forbidden` / `Action Not Allowed` 錯誤**。

#### D. 移除遊戲 (`remove`)
*   **用途**：租戶不想再看到此遊戲 (解除分配)。
*   **邏輯**：**物理刪除** `tenant_games` 表中對應的紀錄。

---

## 4. 服務層架構 (Service Layer)

建議將邏輯拆分為兩個 Service 以符合職責分離：

### 4.1 `IGameService` (系統級)
```php
interface IGameService {
    public function createGame(array $data): Game; // 不含 vip_level
    public function updateGame(int $id, array $data): bool;
    // ...
}
```

### 4.2 `ITenantGameService` (租戶級)
```php
interface ITenantGameService {
    // Admin 用
    public function assignGames(array $tenantIds, array $gameIds, int $vipLevel): void;
    
    // Agent 用
    public function getList(int $tenantId, array $filters): array;
    public function updateConfig(int $tenantId, int $gameId, array $data): bool; // 需內建 VIP 修改防護
    public function removeGame(int $tenantId, int $gameId): bool;
}
```

---

## 5. 驗證與測試重點 (Verification)

1.  **流程測試**：
    *   Admin 新增遊戲 -> Agent 列表 **不應** 出現該遊戲。
    *   Admin 分配遊戲 (設定 VIP=1) -> Agent 列表 **出現** 該遊戲 (且 VIP=1, Enabled=false)。
    *   Agent 上架遊戲 -> 狀態變為 Enabled=true, Published_at 更新。
    *   Agent 移除遊戲 -> Agent 列表 **消失**。

2.  **安全測試**：
    *   Agent 嘗試呼叫 `updateConfig` 修改 `vip_level` -> 系統應忽略或報錯，資料庫值不應改變。

3.  **快取測試**：
    *   Admin 分配/Agent 操作後，前台 API 是否能即時反映變更 (Cache 清除是否正確)。

---

## 6. 結論

此規劃將 Eagle 專案導向一個更嚴謹的「分配式」架構。請開發者務必遵守 **Admin 分配權** 與 **Agent 配置權** 的邊界，切勿在 Agent 端開放不該有的權限 (如 VIP 設定)。
