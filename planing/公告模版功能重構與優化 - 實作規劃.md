# 公告模版功能重構與優化 - 實作規劃

## 版本記錄

| 版本 | 更新時間 | 變更摘要 |
|------|---------|----------|
| v1.0 | 2026-01-21 10:00 | 初次規劃（基於 2026-01-19 Code Review） |

---

## 1. 需求概述

### 1.1 背景與目標
- **需求背景**：根據 2026-01-19 的 Code Review 報告，`feature-announcement-templates` 分支存在多項技術債與潛在問題。主要包括 Controller 違反單一職責原則 (SRP)、代碼重複 (DRY)、方法過長，以及 Model 設定衝突和 Service 邊界檢查缺失。
- **功能目標**：
    1. **重構 Controller**：將業務邏輯（驗證、流程控制）完全遷移至 Service 層，Controller 僅保留請求接收與回應處理。
    2. **消除重複代碼**：整合 Backend 與 Agent 的共用邏輯。
    3. **修復潛在 Bug**：修正 Model 的 `$fillable` 與 `$guarded` 衝突，以及 Service 的 `checkType` 邊界問題。
    4. **優化效能**：減少不必要的資料庫查詢（如建立後重複查詢）。
- **影響範圍**：
    - `app/Http/Controllers/AnnouncementTemplateController.php`
    - `app/Services/AnnouncementTemplate.php`
    - `app/Models/AnnouncementTemplate.php`

### 1.2 範圍界定
- **包含**：
    - Controller 與 Service 的職責分離與重構。
    - Model 屬性設定修正。
    - 依賴注入 (Dependency Injection) 的實作。
    - 單元測試支援性的提升。
- **不包含**：
    - 資料庫 Schema 變更。
    - API 介面規格變更（保持向後相容）。

---

## 2. 系統架構變更

### 2.1 資料庫變更
#### 新增/修改資料表
N/A（本次重構不涉及資料庫結構變更）

### 2.2 設定變更
N/A

### 2.3 程式碼結構

#### 修改檔案
| 檔案路徑 | 修改內容摘要 |
|---------|-------------|
| `app/Models/AnnouncementTemplate.php` | 移除 `$fillable` 中的 `id`，移除 `$guarded` 設定以解決衝突。 |
| `app/Services/AnnouncementTemplate.php` | 1. 修正 `checkType` 邊界檢查。<br>2. 新增 `createWithContents` 與 `updateWithContents` 方法，封裝交易與驗證邏輯。<br>3. 支援 Eager Loading 以解決潛在 N+1 問題。 |
| `app/Http/Controllers/AnnouncementTemplateController.php` | 1. 改用 `__construct` 注入 Service。<br>2. 移除所有業務驗證邏輯。<br>3. 抽取私有方法處理 Backend/Agent 共用流程。<br>4. 修正 Use 引用順序。 |

---

## 3. API 規格設計

**注意**：本次為內部重構，對外 API 介面（Request/Response）保持不變，僅提升內部實作品質與穩定性。

### 3.1 端點總覽
| Method | Path | 說明 | 權限 |
|--------|------|-----|-----|
| POST | `/api/backend/announcement-template` | 新增公告模版 | Backend |
| POST | `/api/backend/agent/announcement-template` | 營運平台新增公告模版 | Agent |
| PUT | `/api/backend/announcement-template` | 修改公告模版 | Backend |
| PUT | `/api/backend/agent/announcement-template` | 營運平台修改公告模版 | Agent |
| GET | `/api/backend/announcement-template` | 取得公告模版資訊 | Backend |
| GET | `/api/backend/agent/announcement-template` | 營運平台取得公告模版資訊 | Agent |
| DELETE | `/api/backend/announcement-template` | 刪除公告模版 | Backend |
| DELETE | `/api/backend/agent/announcement-template` | 營運平台刪除公告模版 | Agent |

---

## 4. 實作細節

### 4.1 實作任務清單

| # | 任務 | 依賴 |
|---|-----|-----|
| 1 | **[Model]** 修正 `AnnouncementTemplate` 的 `$fillable` 與 `$guarded` 衝突 | - |
| 2 | **[Service]** 修正 `checkType` 方法，增加 `isset` 檢查 | - |
| 3 | **[Service]** 實作 `createWithContents` 方法（包含 Provider/Language 檢查、Transaction） | 1, 2 |
| 4 | **[Service]** 實作 `updateWithContents` 方法（包含 Provider/Language 檢查、Transaction） | 3 |
| 5 | **[Controller]** 重構 `__construct`，引入 `AnnouncementTemplateService` 與 `ProviderService` | 4 |
| 6 | **[Controller]** 重構 `createByBackend` 與 `createByAgent`，呼叫 `createWithContents` | 5 |
| 7 | **[Controller]** 重構 `editByBackend` 與 `editByAgent`，呼叫 `updateWithContents` | 6 |
| 8 | **[Controller]** 清理未使用的 Use 與調整順序 | 7 |
| 9 | **[Test]** 執行既有測試確保功能未倒退 | 8 |

### 4.2 關鍵邏輯

#### Service 層封裝 (AnnouncementTemplateService)

```php
public function createWithContents(int $providerId, array $data, array $contents, array $providerLangs): Model
{
    // 1. 業務邏輯驗證
    if (!$this->checkType($data['type'], $data['sub_type'] ?? 0)) {
        throw new NotFoundException('no_such_announcement_sub_type');
    }

    $this->validateLanguages($providerLangs, array_column($contents, 'lang'));

    // 2. 執行交易
    DB::connection('management')->beginTransaction();
    try {
        $template = $this->create($providerId, $data);
        
        // 轉換 contents 格式並寫入
        $formattedContents = $this->formatContents($template->id, $contents);
        $this->upsertContent($formattedContents);
        
        DB::connection('management')->commit();
        
        // 3. 回傳完整物件 (使用 load 避免 N+1)
        return $template->load('contents');
        
    } catch (\Throwable $e) {
        DB::connection('management')->rollback();
        throw $e;
    }
}

public function checkType(int $type, int $subType): bool
{
    if (!isset(IAnnouncement::SUB_TYPES[$type])) {
        return false;
    }
    
    $subTypeConstants = IAnnouncement::SUB_TYPES[$type];
    
    // 若該分類無子分類 (empty)，則 subType 必須為 0
    if (empty($subTypeConstants)) {
        return $subType === 0;
    }

    return in_array($subType, $subTypeConstants);
}
```

#### Controller 層簡化

```php
public function createByBackend(Request $request)
{
    $validated = $this->validate($request, [...]);

    // 依賴注入的 Service
    $provider = $this->providerService->get($validated['provider_id']);
    if (!$provider) {
        throw new NotFoundException('no_such_provider');
    }

    // 呼叫 Service 處理所有邏輯
    $template = $this->templateService->createWithContents(
        $provider['id'],
        $validated, // 包含 subject, type, sub_type
        $validated['contents'],
        $provider['langs']
    );

    return $template;
}
```

### 4.3 錯誤處理設計
| Exception | 錯誤碼 | 觸發條件 |
|-----------|-------|---------|
| NotFoundException | no_such_provider | 營運平台不存在 |
| NotFoundException | no_such_announcement_type | 公告分類不存在 |
| NotFoundException | no_such_announcement_sub_type | 公告子分類不存在 |
| NotFoundException | no_such_language | 語系不支援 |
| RuntimeException | all_languages_are_required | 未填寫所有必填語系 |

---

## 5. 部署與驗證

### 5.1 部署注意事項
- 本次更新僅涉及程式碼邏輯，無須執行 Migration。
- 部署後建議觀察 `laravel-worker` 或 API Log 確認無異常 500 錯誤。

### 5.2 驗證項目

#### 單元測試 / 整合測試
| 測試情境 | 預期結果 |
|---------|---------|
| 新增模版（正常資料） | HTTP 200，回傳包含 contents 的完整模版物件 |
| 新增模版（無效 Provider） | HTTP 404 (no_such_provider) |
| 新增模版（無效 Type/SubType） | HTTP 404 (no_such_announcement_sub_type) |
| 新增模版（缺漏必填語系） | HTTP 500/400 (all_languages_are_required) |
| 修改模版（正常資料） | HTTP 200，資料與 contents 正確更新 |
| Agent 操作 Backend 資料 | 應依據現有邏輯（檢查 provider_id）阻擋或允許（視 Service 實作而定，本次重構維持既有權限邏輯） |

### 5.3 自我檢查點
- [ ] Model `$fillable` 與 `$guarded` 是否已修正？
- [ ] Service `checkType` 是否包含邊界檢查？
- [ ] Controller 是否已移除 DB Transaction 與詳細驗證邏輯？
- [ ] 建立後的重複查詢是否已優化？
- [ ] 所有測試案例皆通過？
