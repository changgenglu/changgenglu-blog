# 公告模版功能重構與優化 - 實作規劃

## 版本記錄

| 版本 | 更新時間 | 變更摘要 |
|------|---------|----------|
| v1.0 | 2026-01-21 10:00 | 初次規劃（基於 2026-01-19 Code Review） |
| v1.1 | 2026-01-21 16:15 | 範圍調整：排除 Controller 結構重構，專注於 Bug 修復與效能優化 |
| v1.2 | 2026-01-21 16:20 | 範圍調整：納入 SRP 重構，排除 DRY 與 DI 重構 |

---

## 1. 需求概述

### 1.1 背景與目標
- **需求背景**：根據 2026-01-19 的 Code Review 報告，`feature-announcement-templates` 分支存在多項技術債與潛在問題。依據最新指示，需進行**Controller 與 Service 的職責分離 (SRP)**，但**不進行 DRY (Backend/Agent 共用邏輯抽取) 與 DI (依賴注入) 重構**。
- **功能目標**：
    1. **職責分離 (SRP)**：將 Controller 中的業務邏輯（如 `provider` 檢查、`type` 檢查、語系驗證、Transaction 處理）下沉至 Service 層。
    2. **修復 Model 設定衝突**：解決 `$fillable` 與 `$guarded` 的衝突。
    3. **修復功能 Bug**：修正 `checkType` 邊界檢查。
    4. **優化效能**：移除建立後的重複查詢，並優化列表 N+1 問題。
- **影響範圍**：
    - `app/Http/Controllers/AnnouncementTemplateController.php`
    - `app/Services/AnnouncementTemplate.php`
    - `app/Models/AnnouncementTemplate.php`

### 1.2 範圍界定
- **包含**：
    - **[SRP]** 將 Controller 的業務邏輯遷移至 Service (`createWithContents`, `updateWithContents`)。
    - **[Fix]** 修復 Model `$fillable` / `$guarded` 衝突。
    - **[Fix]** 修復 `checkType` 索引未定義錯誤。
    - **[Perf]** 優化 Controller 重複查詢邏輯與 Service 列表查詢 (Eager Loading)。
- **不包含**：
    - **[DRY]** 抽取 Backend 與 Agent 的共用 Controller 邏輯。
    - **[DI]** 建構子依賴注入 (Dependency Injection) 重構（維持 `app('Service')->init(...)` 模式）。
    - 拆分過長方法（除非因 SRP 自然縮短）。

---

## 2. 系統架構變更

### 2.1 資料庫變更
N/A

### 2.2 設定變更
N/A

### 2.3 程式碼結構

#### 修改檔案
| 檔案路徑 | 修改內容摘要 |
|---------|-------------|
| `app/Models/AnnouncementTemplate.php` | 移除 `$fillable` 中的 `id`，移除 `$guarded`。 |
| `app/Services/AnnouncementTemplate.php` | 1. 新增 `createWithContents` 封裝新增邏輯。<br>2. 新增 `updateWithContents` 封裝更新邏輯。<br>3. 修正 `checkType` 邊界。<br>4. 優化 `lists` Eager Loading。 |
| `app/Http/Controllers/AnnouncementTemplateController.php` | 1. 移除業務邏輯與 Transaction。<br>2. 改呼叫 Service 的新方法。<br>3. 維持 `app('Service')` 呼叫方式。 |

---

## 3. API 規格設計

**注意**：本次為內部重構，對外 API 介面保持不變。

### 3.1 端點總覽
(與現有 API 一致)

### 3.2 詳細規格
(與現有規格一致)

---

## 4. 實作細節

### 4.1 實作任務清單

| # | 任務 | 依賴 |
|---|-----|-----|
| 1 | **[Model]** 修正 `AnnouncementTemplate` 的 `$fillable` 與 `$guarded` 衝突 | - |
| 2 | **[Service]** 修正 `checkType` 方法，增加 `isset` 檢查 | - |
| 3 | **[Service]** 實作 `createWithContents` (含 Transaction、驗證、寫入) | 1, 2 |
| 4 | **[Service]** 實作 `updateWithContents` (含 Transaction、驗證、更新) | 3 |
| 5 | **[Service]** 修改 `lists` 方法，支援 `with` 參數 (Eager Loading) | - |
| 6 | **[Controller]** 重構 `createByBackend` 與 `createByAgent`，呼叫 `createWithContents` | 3 |
| 7 | **[Controller]** 重構 `editByBackend` 與 `editByAgent`，呼叫 `updateWithContents` | 4 |
| 8 | **[Controller]** 移除重複查詢，清理 Use Import | 6, 7 |

### 4.2 關鍵邏輯

#### Service 層擴充 (AnnouncementTemplateService)

```php
// 維持既有 class 結構，不使用建構子注入其他 Service (因不進行 DI 重構)
// 若需使用其他 Service，使用 app('Service')->init(...)

public function createWithContents(int $providerId, array $data, array $contents, array $providerLangs): Model
{
    // 1. 業務驗證
    if (!$this->checkType($data['type'], $data['sub_type'] ?? 0)) {
        throw new NotFoundException('no_such_announcement_sub_type');
    }

    // 驗證語系 (需搬移/實作 validateLanguages 邏輯)
    $postLangs = array_column($contents, 'lang');
    if (count(array_diff($providerLangs, $postLangs)) > 0) {
        throw new RuntimeException('all_languages_are_required', ['langs' => $providerLangs]);
    }
    // ... 其他語系驗證

    // 2. 交易處理
    $db = DB::connection('management');
    $db->beginTransaction();
    try {
        $template = $this->create($providerId, $data);
        
        $formattedContents = [];
        foreach ($contents as $content) {
             $formattedContents[] = [
                'template_id' => $template->id,
                'lang' => $content['lang'],
                'title' => $content['title'],
                'article' => $content['article'],
            ];
        }
        $this->upsertContent($formattedContents);
        
        $db->commit();
        
        return $template->load('contents'); // Eager loading 回傳
    } catch (\Throwable $e) {
        $db->rollback();
        throw $e;
    }
}
```

#### Controller 層瘦身

```php
public function createByBackend(Request $request)
{
    $validated = $this->validate($request, [...]);

    $provider = app('Service')->init('Providers')->get($validated['provider_id']);
    if (!$provider) {
        throw new NotFoundException('no_such_provider');
    }

    // 呼叫 Service 封裝後的方法
    $template = app('Service')->init('AnnouncementTemplate')->createWithContents(
        $provider['id'],
        $validated,
        $validated['contents'],
        $provider['langs']
    );

    return $template;
}
```

### 4.3 錯誤處理設計
| Exception | 錯誤碼 | 觸發條件 |
|-----------|-------|---------|
| NotFoundException | no_such_announcement_sub_type | 子分類驗證失敗 (Service 拋出) |
| RuntimeException | all_languages_are_required | 語系驗證失敗 (Service 拋出) |

---

## 5. 部署與驗證

### 5.1 部署注意事項
- 無需 Migration。

### 5.2 驗證項目

#### 單元測試 / 整合測試
| 測試情境 | 預期結果 |
|---------|---------|
| 新增模版 | Controller 僅負責參數傳遞，Service 負責寫入 DB，結果正確 |
| 業務規則驗證 | Service 正確拋出 Exception (如語系不足、分類錯誤) |
| N+1 檢查 | 列表 API 查詢次數顯著減少 |

### 5.3 自我檢查點
- [ ] Model 屬性衝突已解決？
- [ ] Service `checkType` 已修復？
- [ ] Controller 是否已無 Transaction 與業務邏輯？
- [ ] 是否維持使用 `app('Service')` (無 DI 重構)？
