# 介面定義規範指南

## 目錄
- [概述](#概述)
- [基礎規範](#基礎規範)
- [型別宣告規範](#型別宣告規範)
- [回傳值規範](#回傳值規範)
- [方法命名規範](#方法命名規範)
- [DocBlock 註解規範](#docblock-註解規範)
- [依存關係處理](#依存關係處理)
- [常見問題與解決方案](#常見問題與解決方案)
- [實作範例](#實作範例)

---

## 概述

### 介面的目的
介面（Interface）在軟體架構中提供抽象層級，定義類別必須實作的方法契約，達成：
1. **依賴反轉**：高階模組不依賴低階模組，兩者都依賴抽象
2. **可替換性**：可替換實作而不影響使用方
3. **易於測試**：可建立 mock 物件進行單元測試
4. **程式碼重用**：透過介面統一不同實作的使用方式

### 介面設計原則
- **介面隔離原則**：介面應小而專注，而非巨集接口
- **單一職責**：每個介面應該只負責一種類型的功能
- **可擴展性**：介面應考慮未來可能的需求變更
- **向後相容性**：修改介面必須考慮對現有實作的影響

---

## 基礎規範

### 1. 介面命名規範

```php
// ✅ 正確：介面以 I 開頭
interface IGoogleCloudArmor
{
}

// ✅ 也可以：明確表達用途
interface SecurityPolicyInterface
{
}

// ❌ 錯誤：介面不應以 I 結尾或其他不清晰的方式命名
interface GoogleCloudArmorImpl
{
}
```

**命名建議**：
- 以 `I` 開頭（如 `IUser`, `IGoogleCloudArmor`）
- 或使用描述性的 Interface 後綴（如 `UserInterface`, `SecurityPolicyInterface`）
- 保持與實作類別名稱的對應關係（如 `IGoogleCloudArmor` → `GoogleCloudArmorApi`）

### 2. 介面檔案結構

```php
<?php

namespace App\Interfaces;

/**
 * Google Cloud Armor API 介面定義
 *
 * 此介面定義了與 Google Cloud Armor 服務互動所需的所有方法
 *
 * @package App\Interfaces
 */
interface IGoogleCloudArmor
{
    /**
     * 獲取認證令牌
     *
     * @return string|null 訪問令牌，失敗時返回 null
     */
    public function getAccessToken(): ?string;

    // 其他方法...
}
```

---

## 型別宣告規範

### 1. 強制型別宣告

所有方法**必須**包含：
- 參數型別宣告
- 回傳值型別宣告

```php
// ✅ 正確：完整型別宣告
public function getSecurityPolicy(string $policyName): ?array;

// ❌ 錯誤：缺少型別宣告
public function getSecurityPolicy($policyName);

// ❌ 錯誤：缺少回傳值型別
public function getSecurityPolicy(string $policyName);
```

### 2. 支援的 PHP 型別

```php
interface IExample
{
    // 標量型別
    public function processString(string $input): string;
    public function processInt(int $number): int;
    public function processFloat(float $value): float;
    public function processBool(bool $flag): bool;

    // 複合型別
    public function processArray(array $data): array;
    public function processObject(object $obj): object;

    // 可為空型別
    public function findItem(string $id): ?Item;
    public function getOptional(): ?string;

    // 混合型別
    public function process(mixed $data): mixed;

    // 無回傳值
    public function voidMethod(): void;
}
```

### 3. 實作類別必須匹配

```php
// 介面定義
interface IExample
{
    public function process(string $input): string;
}

// ✅ 正確：實作完全匹配
class ExampleService implements IExample
{
    public function process(string $input): string
    {
        return $input;
    }
}

// ❌ 錯誤：型別不匹配
class ExampleService implements IExample
{
    public function process($input)  // 缺少型別
    {
        return $input;
    }
}
```

---

## 回傳值規範

### 1. 明確的回傳值結構

使用 DocBlock 明確指定回傳結構：

```php
/**
 * 獲取安全政策規則
 *
 * @param string $policyName 政策名稱
 * @return array{
 *     rules: array<int, array{
 *         priority: int,
 *         description: string,
 *         action: string,
 *         ips: array<string>
 *     }>,
 *     ips: array<string>
 * }
 */
public function getSecurityPolicyRules(string $policyName): array;
```

### 2. 複雜回傳值範例

```php
/**
 * 獲取格式化的安全政策規則
 *
 * @param string $policyName 政策名稱
 * @return array{
 *     all_rules: array<int, array{
 *         priority: int,
 *         description: string,
 *         action: string,
 *         ips: array<string>
 *     }>,
 *     all_ips: array<string>
 * }
 */
public function getFormattedSecurityPolicyRules(string $policyName): array;
```

### 3. 錯誤處理

```php
// 回傳 null 表示失敗
public function getSecurityPolicy(string $policyName): ?array;

// 回傳空陣列表示無資料
public function getAllSecurityPolicies(): array;

// 回傳布林表示操作成功/失敗
public function deleteSecurityPolicyRule(string $policyName, int $priority): bool;
```

---

## 方法命名規範

### 1. 動詞開頭

```php
// ✅ 正確：方法名以動詞開頭
public function getAccessToken(): ?string;
public function addSecurityPolicyRule(...): ?array;
public function updateSecurityPolicyRule(...): ?array;
public function deleteSecurityPolicyRule(...): bool;

// ❌ 錯誤：方法名不應是名詞
public function accessToken(): ?string;
```

### 2. 動詞對應操作

| 操作類型 | 動詞 | 範例 |
|---------|------|------|
| 獲取資料 | get, fetch, retrieve | `getSecurityPolicy()` |
| 新增資料 | add, create, insert | `addSecurityPolicyRule()` |
| 更新資料 | update, modify, change | `updateSecurityPolicyRule()` |
| 刪除資料 | delete, remove, destroy | `deleteSecurityPolicyRule()` |
| 檢查條件 | is, has, can, should | `isValid()`, `hasRule()` |

### 3. 複數命名

```php
// 單數物件
public function getUser(int $id): User;

// 複數集合
public function getUsers(): array;  // 回傳 User[]
```

---

## DocBlock 註解規範

### 1. 完整的方法註解

```php
/**
 * 方法簡述（一行描述）
 *
 * 詳細說明（多行描述，說明方法的作用、使用場景、特殊注意事項等）
 *
 * @param string $policyName 政策名稱
 * @param int $priority 優先級
 * @param string $description 規則描述
 * @param string $action 動作（allow/deny）
 * @param array<string> $ipRanges IP 範圍列表
 * @return array|null 新增的規則資料，失敗時返回 null
 * @throws \Exception 當新增規則失敗時拋出異常
 *
 * @example
 * $result = $api->addSecurityPolicyRule(
 *     'stars',
 *     1000,
 *     '遊戲廠商-aw',
 *     'allow',
 *     ['192.168.1.1/32']
 * );
 */
public function addSecurityPolicyRule(
    string $policyName,
    int $priority,
    string $description,
    string $action,
    array $ipRanges
): ?array;
```

### 2. @param 標籤規範

```php
/**
 * @param string $policyName 政策名稱，例如 'stars' 或 'member-oversea-qc'
 * @param int $priority 優先級，數字越小優先級越高
 * @param array<string> $ips 要新增的 IP 陣列，例如 ['192.168.1.1/32', '10.0.0.1/32']
 */
```

### 3. @return 標籤規範

```php
/**
 * @return array{
 *     success: bool,
 *     total_ips: int,
 *     processed_count: int,
 *     results: array<int, array{action: string, ip: string}>
 * }
 */
```

### 4. 複雜型別註解

```php
// 多維陣列
/**
 * @return array<int, array{id: int, name: string, active: bool}>
 */

// 陣列鍵名
/**
 * @return array<string, array{count: int, rules: array<int>}>
 */

// 混合結構
/**
 * @return array{
 *     rules: array<int, array<string, mixed>>,
 *     metadata: array<string, mixed>
 * }
 */
```

---

## 依存關係處理

### 1. callable 參數

#### 使用 callable（簡單但型別弱）

```php
/**
 * 依描述過濾規則
 *
 * @param array $rules 所有規則
 * @param callable(string): bool $filterCallback 過濾回調函數，接收描述字串，返回是否保留
 * @return array 過濾後的規則
 */
public function filterRulesByDescription(array $rules, callable $filterCallback): array;
```

#### 定義專用介面（型別強，複雜度高）

```php
interface IFilterCallback
{
    /**
     * 判斷是否保留此規則
     *
     * @param string $description 規則描述
     * @return bool true 表示保留，false 表示過濾
     */
    public function __invoke(string $description): bool;
}

/**
 * 依描述過濾規則
 *
 * @param array $rules 所有規則
 * @param IFilterCallback $filterCallback 過濾回調函數
 * @return array 過濾後的規則
 */
public function filterRulesByDescription(array $rules, IFilterCallback $filterCallback): array;
```

**建議**：
- 簡單的回調：使用 `callable`
- 複雜的回調：定義專用介面
- 回調的參數/回傳值已在 DocBlock 說明

### 2. 陣列參數

```php
/**
 * 新增 IP 到規則
 *
 * @param array<string> $ips IP 地址陣列
 */
public function addIps(array $ips): void;

/**
 * 複雜結構陣列
 *
 * @param array<int, array{priority: int, ips: array<string>}> $rules 規則陣列
 */
public function processRules(array $rules): void;
```

### 3. 可選參數

```php
/**
 * 獲取安全政策
 *
 * @param string|null $policyName 政策名稱，null 表示獲取所有政策
 * @return array
 */
public function getSecurityPolicy(?string $policyName): array;

/**
 * 使用預設值
 *
 * @param int $priority 優先級（預設為下一個可用優先級）
 */
public function addRule(string $name, int $priority = 0): array;
```

---

## 常見問題與解決方案

### 問題 1: 介面與實作型別不一致

**問題描述**：
```php
// 介面定義
interface IApi
{
    public function getData(string $id): array;
}

// 實作類別
class ApiImpl implements IApi
{
    public function getData($id)  // 缺少型別宣告
    {
        // ...
    }
}
```

**解決方案**：
```php
class ApiImpl implements IApi
{
    public function getData(string $id): array  // 必須包含完整型別宣告
    {
        // ...
    }
}
```

### 問題 2: 回傳值結構不明確

**問題描述**：
```php
public function getRules(): array;  // 不清楚回傳什麼結構
```

**解決方案**：
```php
/**
 * 獲取規則列表
 *
 * @return array{
 *     rules: array<int, array{priority: int, ips: array<string>}>,
 *     total: int
 * }
 */
public function getRules(): array;
```

### 問題 3: callable 型別過於寬泛

**問題描述**：
```php
public function filter(callable $callback): array;
// 不知道 callback 的簽名
```

**解決方案**：
```php
/**
 * 過濾規則
 *
 * @param array $rules
 * @param callable(array, string): bool $callback
 *     - 第一個參數：規則資料
 *     - 第二個參數：規則描述
 *     - 回傳值：是否保留此規則
 * @return array
 */
public function filter(array $rules, callable $callback): array;
```

### 問題 4: 介面方法是否應該包含業務邏輯？

**不應該**。介面僅定義契約，不包含實作：

```php
// ❌ 錯誤：介面不應包含實作
interface IApi
{
    public function process(): string
    {
        return 'result';  // 介面不能有實作
    }
}

// ✅ 正確：只定義方法簽名
interface IApi
{
    public function process(): string;
}
```

### 問題 5: 介面應該包含哪些方法？

**原則**：
- ✅ 其他類別會呼叫的方法（public 方法）
- ✅ 需要被 mock 的依賴方法
- ❌ 私有方法（private）
- ❌ 僅實作內部使用的輔助方法（helper methods）
- ❌ 不期望被外部呼叫的內部邏輯

**判斷標準**：如果在測試或生產環境中，有其他類別需要呼叫這個方法，就應該在介面中定義。

---

## 實作範例

### 完整介面範例

```php
<?php

namespace App\Interfaces;

/**
 * Google Cloud Armor API 介面定義
 *
 * 此介面定義了與 Google Cloud Armor 服務互動的所有方法
 *
 * @package App\Interfaces
 * @author Stars Team
 * @since 1.0
 */
interface IGoogleCloudArmor
{
    /**
     * 獲取認證令牌
     *
     * 從 Google Cloud 服務獲取 OAuth 2.0 訪問令牌
     *
     * @return string|null 訪問令牌，失敗時返回 null
     * @throws \Exception 當認證失敗時拋出異常
     */
    public function getAccessToken(): ?string;

    /**
     * 獲取所有安全政策
     *
     * 獲取專案中所有的安全政策及其規則
     *
     * @return array<int, array{
     *     name: string,
     *     description: string,
     *     rules: array
     * }> 所有安全政策列表
     */
    public function getSecurityPolicies(): array;

    /**
     * 獲取指定安全政策
     *
     * @param string $policyName 政策名稱
     * @return array{
     *     name: string,
     *     description: string,
     *     rules: array
     * }|null 政策資料，不存在時返回 null
     */
    public function getSecurityPolicy(string $policyName): ?array;

    /**
     * 獲取安全政策規則
     *
     * @param string $policyName 政策名稱
     * @return array{
     *     rules: array<int, array{
     *         priority: int,
     *         description: string,
     *         action: string,
     *         ips: array<string>
     *     }>,
     *     ips: array<string>
     * }
     */
    public function getSecurityPolicyRules(string $policyName): array;

    /**
     * 新增安全政策規則
     *
     * @param string $policyName 政策名稱
     * @param int $priority 優先級
     * @param string $description 規則描述
     * @param string $action 動作（allow/deny）
     * @param array<string> $ipRanges IP 範圍列表
     * @return array|null 新增的規則資料，失敗時返回 null
     */
    public function addSecurityPolicyRule(
        string $policyName,
        int $priority,
        string $description,
        string $action,
        array $ipRanges
    ): ?array;

    /**
     * 更新安全政策規則
     *
     * @param string $policyName 政策名稱
     * @param int $priority 優先級
     * @param string $description 規則描述
     * @param string $action 動作（allow/deny）
     * @param array<string> $ipRanges IP 範圍列表
     * @return array|null 更新後的規則資料
     */
    public function updateSecurityPolicyRule(
        string $policyName,
        int $priority,
        string $description,
        string $action,
        array $ipRanges
    ): ?array;

    /**
     * 刪除安全政策規則
     *
     * @param string $policyName 政策名稱
     * @param int $priority 優先級
     * @return bool 刪除成功返回 true，失敗返回 false
     */
    public function deleteSecurityPolicyRule(string $policyName, int $priority): bool;

    /**
     * 智慧新增 IP 到規則
     *
     * 自動處理每個規則最多 10 個 IP 的限制，智能分配到現有規則或建立新規則
     *
     * @param string $policyName 政策名稱
     * @param array<int, array{priority: int, description: string, action: string, ips: array<string>}> $rules 現有規則陣列
     * @param array<string> $ips 要新增的 IP 陣列
     * @param string $baseDescription 基礎描述（用於建立新規則）
     * @param int|null $startPriority 起始優先權（用於建立新規則）
     * @return array<int, array{
     *     action: string,
     *     rule_description: string,
     *     priority: int,
     *     added_ips?: array<string>,
     *     added_count?: int,
     *     total_ips_in_rule?: int,
     *     error?: string
     * }> 處理結果
     */
    public function smartAddIpsToRules(
        string $policyName,
        array $rules,
        array $ips,
        string $baseDescription,
        ?int $startPriority
    ): array;

    /**
     * 智慧移除 IP 從規則
     *
     * 自動處理 IP 移除，當規則變空時自動刪除規則
     *
     * @param string $policyName 政策名稱
     * @param array<int, array{priority: int, description: string, action: string, ips: array<string>}> $rules 現有規則陣列
     * @param array<string> $ips 要移除的 IP 陣列
     * @return array{
     *     success: bool,
     *     total_ips: int,
     *     processed_count: int,
     *     not_found_count: int,
     *     processed_ips: array<string>,
     *     not_found_ips: array<string>,
     *     api_calls: int,
     *     results: array
     * }
     */
    public function smartRemoveIpsFromRules(
        string $policyName,
        array $rules,
        array $ips
    ): array;

    /**
     * 獲取格式化的安全政策規則
     *
     * @param string $policyName 政策名稱
     * @return array{
     *     all_rules: array<int, array{
     *         priority: int,
     *         description: string,
     *         action: string,
     *         ips: array<string>
     *     }>,
     *     all_ips: array<string>
     * }
     */
    public function getFormattedSecurityPolicyRules(string $policyName): array;

    /**
     * 依描述過濾規則
     *
     * @param array<int, array{description: string}> $rules 所有規則
     * @param callable(string): bool $filterCallback 過濾回調函數，接收描述字串，返回是否保留
     * @return array 過濾後的規則
     */
    public function filterRulesByDescription(array $rules, callable $filterCallback): array;

    /**
     * 依描述分組規則
     *
     * @param array $rules 規則陣列
     * @param callable(string): ?string $groupCallback 分組回調函數，接收描述字串，返回組名或 null
     * @return array<string, array> 分組後的規則
     */
    public function groupRulesByDescription(array $rules, callable $groupCallback): array;

    /**
     * 依群組獲取規則
     *
     * @param string $policyName 政策名稱
     * @param string $groupIdentifier 組識別符（如平台代碼）
     * @param callable(string, string): bool $matchCallback 匹配回調函數，接收描述和識別符，返回是否匹配
     * @return array 匹配的規則
     */
    public function getRulesByGroup(string $policyName, string $groupIdentifier, callable $matchCallback): array;
}
```

### 對應的實作類別範例

```php
<?php

namespace App\Library;

use App\Interfaces\IGoogleCloudArmor;

class GoogleCloudArmorApi implements IGoogleCloudArmor
{
    // ✅ 必須實作所有介面方法
    public function getAccessToken(): ?string
    {
        // 實作...
    }

    public function getSecurityPolicies(): array
    {
        // 實作...
    }

    // ... 其他方法
}
```

---

## 檢查清單

在設計介面時，使用此清單確認完整性：

- [ ] 所有方法都有型別宣告（參數和回傳值）
- [ ] DocBlock 完整且描述清楚
- [ ] 回傳值結構有明確定義
- [ ] 方法命名符合動詞開頭規範
- [ ] 錯誤處理方式明確（null/空陣列/布林）
- [ ] callable 參數有清楚的簽名說明
- [ ] 沒有業務邏輯實作
- [ ] 介面不包含私有方法
- [ ] 介面方法是其他類別需要呼叫的方法
- [ ] 考慮未來擴展的可能性

---

## 參考資源

### Laravel 相關
- [Laravel Service Container](https://laravel.com/docs/10.x/container)
- [Laravel Testing: Mocking Objects](https://laravel.com/docs/10.x/testing#mocking-objects)

### PHP 相關
- [PHP: Type Declarations](https://www.php.net/manual/en/language.types.declarations.php)
- [PHP: Interfaces](https://www.php.net/manual/en/language.oop5.interfaces.php)
- [PHP: DocBlock](https://docs.phpdoc.org/3.0/guide/references/phpdoc/basic-syntax.html)

### 設計模式
- [SOLID Principles](https://en.wikipedia.org/wiki/SOLID)
- [Dependency Inversion Principle](https://en.wikipedia.org/wiki/Dependency_inversion_principle)
- [Interface Segregation Principle](https://en.wikipedia.org/wiki/Interface_segregation_principle)
