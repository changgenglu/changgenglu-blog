# stars-feature-batch-game-language-setting.md

## 版本記錄

| 版本 | 更新時間         | 變更摘要 |
| ---- | ---------------- | -------- |
| v1.4 | 2026-01-28 14:16 | 針對 commits 57003140、953e1009 重新審查 |
| v1.3 | 2026-01-26       | 最終審查 (Commit: 57003140)：確認預設語系校準邏輯已優化 |
| v1.2 | 2026-01-26       | 回饋修正審查：移除 description、重構交易機制、確認效能技術債 |
| v1.1 | 2026-01-26       | 更新審查 (Commit: d6d1e4e7) - 確認問題仍存在 |
| v1.0 | 2026-01-23       | 初次審查 |

---

## 變更摘要

| 項目       | 內容                                   |
| ---------- | -------------------------------------- |
| 變更檔案數 | 3 個                                   |
| 變更類型   | 新功能 / 修復                          |
| 影響範圍   | 遊戲語系批次設定、API Route、語系維護 |

---

## 問題清單

### 🔴 嚴重（必須修復）

| 檔案:行號 | 問題描述 | 建議修復 |
| --------- | -------- | -------- |
| —         | 無       | —        |

### 🟡 警告（建議修復）

| 檔案:行號 | 問題描述 | 建議修復 |
| --------- | -------- | -------- |
| `app/Http/Controllers/GameController.php:1075` | 當 `game_ids` 包含重複值時，`count(array_unique())` 會小於原始數量，導致誤判為 `no_such_game`。這會把「重複輸入」當成「不存在」錯誤。 | 若允許重複，改成以唯一集合比對並在驗證層加上 `distinct`；若不允許重複，改為驗證錯誤（ParameterException/Validation）。 |
| `app/Http/Controllers/GameController.php:1114` | `foreach ($games['list'] as $game)` 中對 `$game['support_langs']` 的賦值可能不會回寫到回傳集合（若元素為陣列或非引用型別）。 | 改用 `map/transform` 或 `each` 明確回寫集合，確保回傳結構包含 `support_langs`。 |
| `app/Services/GameSupportLanguage.php:218` | `gameIds * langs` 直接累積到 `$data`，在大量資料時可能造成記憶體與 `max_allowed_packet` 風險。 | 使用 `array_chunk` 分批 `insert` 或改用 `upsert`/批次寫入策略。 |

### 🔵 建議（可選修復）

| 檔案:行號 | 問題描述 | 建議修復 |
| --------- | -------- | -------- |
| `app/Http/Controllers/GameController.php:1096` | 針對每個遊戲逐一迭代所有供應商清快取，為 O(G×P) 操作，批量操作時成本高。 | 考慮將清快取改為佇列任務或批次失效機制，降低同步耗時。 |

---

## 審查結論

### 各類別評分

| 類別       | 權重 | 得分  | 狀態 | 說明 |
| ---------- | ---- | ----- | ---- | ---- |
| SOLID 原則 | 25%  | 90    | ✅   | Service/Controller 職責分離清楚 |
| 程式碼品質 | 20%  | 85    | ✅   | 結構清晰，無明顯複雜度失控 |
| 功能正確性 | 15%  | 75    | ⚠️   | 重複 game_ids 與回傳欄位一致性風險 |
| 安全性     | 15%  | 90    | ✅   | 輸入驗證與例外處理完整 |
| 多層架構   | 15%  | 85    | ✅   | 符合 Controller → Service 分層 |
| 效能       | 5%   | 70    | ⚠️   | 批次快取清除與大量 insert 成本 | 
| 可測試性   | 5%   | 60    | ⚠️   | 未見對應測試覆蓋 |

### 總分計算

**加權總分**：83.5 / 100

### 合併判定

| 分數區間 | 判定      | 行動             |
| -------- | --------- | ---------------- |
| 70-89    | ⚠️ 良好   | 修復警告後可合併 |

**最終結論**：⚠️ 修復警告後可合併
