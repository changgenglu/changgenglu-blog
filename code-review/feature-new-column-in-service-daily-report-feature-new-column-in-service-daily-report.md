# feature-new-column-in-service-daily-report-feature-new-column-in-service-daily-report.md

## 版本記錄

| 版本 | 更新時間 | 變更摘要 |
|------|---------|----------|
| v1.0 | 2026-02-04 | 初次審查：新增每日服務報表儲值欄位 |

---

## 變更摘要

| 項目       | 內容                 |
| ---------- | -------------------- |
| 變更檔案數 | 5 個                 |
| 變更類型   | 新功能               |
| 影響範圍   | 每日報表統計 (Command)、後台報表 API (Controller)、資料模型 (Model/Migration) |

---

## 問題清單

### 🔴 嚴重（必須修復）

| 檔案:行號           | 問題描述           | 建議修復                   |
| ------------------- | ------------------ | -------------------------- |
| `app/Console/Commands/MakeServiceDailyReport.php:48-50` | **原子鎖 (Lock) 機制被註解**：這會導致多個實例同時執行報表統計，造成數據重複或競爭條件。 | 應還原 `checkLock` 的呼叫以確保單一執行。 |
| `app/Console/Commands/MakeServiceDailyReport.php:105-106` | **VIP 等級統計邏輯被註解**：導致報表中的 `vip0`~`vip10` 數據皆為 0，失去報表準確性。 | 應還原 `getVipLevelMemberCount` 的呼叫。 |
| `app/Console/Commands/MakeServiceDailyReport.php:158-167` | **殘留偵錯程式碼**：`dump()` 函式會導致腳本輸出非預期資訊。 | 應移除 `dump()` 區塊。 |

### 🟡 警告（建議修復）

| 檔案:行號          | 問題描述     | 建議修復           |
| ------------------ | ------------ | ------------------ |
| `database/migrations/2026_02_04_184146_add_deposit_columns_to_service_daily_report_table.php:18-23` | **資料型別精度風險**：使用 `double` 儲存金額。雖然專案中部分現有欄位亦使用 double，但在涉及精確財務計算時 `decimal` 更為安全。 | 建議評估是否改用 `decimal(20, 4)`，若遵循專案現有慣例則可保持原樣。 |

### 🔵 建議（可選修復）

| 檔案:行號          | 問題描述         | 建議修復                  |
| ------------------ | ---------------- | ------------------------- |
| `app/Http/Controllers/ReportController.php:245-250` | **可選鍵值檢查**：使用了 `?? 0`。雖然有利於相容舊資料，但 Migration 執行後資料庫預設值即為 0。 | 為求一致性可保留，或在確認全環境執行 Migration 後簡化。 |

---

## 審查結論

### 各類別評分

| 類別       | 權重 | 得分  | 狀態     | 說明 |
| ---------- | ---- | ----- | -------- | ---- |
| SOLID 原則 | 25%  | 90    | ✅ | 遵循 Service/Repository 與層級職責。 |
| 程式碼品質 | 20%  | 60    | ⚠️ | 包含 Debug 程式碼與大量註解，需清理。 |
| 功能正確性 | 15%  | 50    | ❌ | 核心統計邏輯與鎖定機制被人為停用。 |
| 安全性     | 15%  | 70    | ⚠️ | 原子鎖停用可能導致併發競爭風險。 |
| 多層架構   | 15%  | 95    | ✅ | 嚴格遵守 Controller -> Service -> Model 流程。 |
| 效能       | 5%   | 90    | ✅ | 報表統計邏輯尚無顯著效能瓶頸。 |
| 可測試性   | 5%   | 80    | ✅ | 結構清晰，易於撰寫單元測試。 |

### 總分計算

**加權總分**：71.5 / 100

### 合併判定

| 分數區間 | 判定      | 行動             |
| -------- | --------- | ---------------- |
| 70-89    | ⚠️ 良好   | 修復警告後可合併 |

**最終結論**：⚠️ 修復後可合併
