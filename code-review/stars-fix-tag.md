# stars-fix-tag.md

## 版本記錄

| 版本 | 更新時間 | 變更摘要 |
|------|---------|----------|
| v1.2 | 2026-02-09 17:00 | 深度審查：分析 type 開放修改之影響與 API 參數同步確認 |
| v1.1 | 2026-02-09 16:45 | 修正 Apidoc 參數與驗證長度同步 |
| v1.0 | 2026-02-09 16:30 | 初次審查：標籤系統類型化重構 |

---

## 變更摘要

| 項目       | 內容                 |
| ---------- | -------------------- |
| 變更檔案數 | 8 個                 |
| 變更類型   | 重構 / 新功能         |
| 影響範圍   | 標籤管理、標籤群組、API 相容性 |

---

## 問題清單

### 🔴 嚴重（必須修復）

| 檔案:行號           | 問題描述           | 建議修復                   |
| ------------------- | ------------------ | -------------------------- |
| `TagController.php:517` | **API 參數變更**：`tagGroupLists` 的查詢參數由 `id` 正式更名為 `group_id`。 | 確認前端所有調用端已同步修改，或在後端暫時保留 `id` 作為 Alias 以維持相容性。 |
| `app/Services/Tags.php:267` | **邏輯衝突**：`getCategoryTags` 仍使用硬編碼的 ID 範圍 (100-1000) 判定類型。 | 若 `type` 欄位開放編輯但 `id` 不變，此方法將回傳錯誤類型的標籤。應改為依據 `type` 欄位查詢。 |

### 🟡 警告（建議修復）

| 檔案:行號          | 問題描述     | 建議修復           |
| ------------------ | ------------ | ------------------ |
| `app/Services/Tags.php:15` | **快取一致性**：`removeCache` 尚未實作。 | 開放 `type` 編輯後，若存在依類型分組的快取，標籤變更類型時必須清除相關快取，否則列表資料會產生錯誤。 |
| `TagController.php:189` | **業務邏輯風險**：開放編輯 `type` 可能導致標籤在「標籤群組」中產生語意不符。 | 標籤群組 (TagGroups) 與標籤的關聯是透過 `id`。若標籤 A (原本為國家) 已被加入「國家群組」，編輯後改為「遊戲分類」，它仍會留在「國家群組」中。 |

### 🔵 建議（可選修復）

| 檔案:行號          | 問題描述         | 建議修復                  |
| ------------------ | ---------------- | ------------------------- |
| `TagController.php:208` | 重複的欄位賦值邏輯。 | 考慮使用 `request()->only($updatableKeys)` 簡化代碼。 |

---

## 開放修改 `type` 的影響分析

開放 `type` 欄位修改雖然增加了靈活性，但存在以下風險：

1.  **ID 範圍依賴問題**：專案中原本存在「ID 區間即類型」的隱性規則（如 `100~199` 為老虎機）。若修改 `type` 但 `id` 保持不變，會破壞此規則，導致依賴 ID 判斷類型的舊邏輯失效。
2.  **語意連貫性**：標籤與群組的關聯是持久的。類型變更會導致既有群組內的內容變得雜亂（例如一個「主題群組」內出現了「國家」標籤）。
3.  **快取分區**：若未來實作 Redis 快取，通常會依 `type` 建立 Key。編輯 `type` 時若未妥善處理，會導致舊類型的快取殘留，新類型的快取未更新。

**建議方案**：
- 檢查全專案是否還有透過 `id` 區間判斷類型的代碼（除 `getCategoryTags` 外）。
- 在修改 `type` 時，應一併檢查並清除該標籤相關的所有關聯快取。

---

## 審查結論

### 各類別評分

| 類別       | 權重 | 得分  | 狀態     | 說明 |
| ---------- | ---- | ----- | -------- | ---- |
| SOLID 原則 | 25%  | 85    | ✅ | 架構清晰，唯獨 ID 範圍邏輯與 type 欄位存在權責衝突。 |
| 程式碼品質 | 20%  | 90    | ✅ | 代碼整潔度高。 |
| 功能正確性 | 15%  | 75    | ⚠️ | `getCategoryTags` 存在潛在 Bug。 |
| 安全性     | 15%  | 95    | ✅ | 安全實作良好。 |
| 多層架構   | 15%  | 85    | ✅ | Service 層隔離良好。 |
| 效能       | 5%   | 90    | ✅ | 索引設計正確。 |
| 可測試性   | 5%   | 80    | ✅ | - |

### 總分計算

**加權總分**：85 / 100

### 合併判定

| 分數區間 | 判定      | 行動             |
| -------- | --------- | ---------------- |
| 70-89    | ⚠️ 良好   | 修復警告後可合併 |

**最終結論**：⚠️ 修復後可合併
