# stars-fix-tag.md

## 版本記錄

| 版本 | 更新時間 | 變更摘要 |
|------|---------|----------|
| v1.0 | 2026-02-09 16:30 | 初次審查：標籤系統類型化重構 |

---

## 變更摘要

| 項目       | 內容                 |
| ---------- | -------------------- |
| 變更檔案數 | 8 個                 |
| 變更類型   | 重構 / 新功能         |
| 影響範圍   | 標籤管理、標籤群組、資料庫架構 |

---

## 問題清單

### 🔴 嚴重（必須修復）

| 檔案:行號           | 問題描述           | 建議修復                   |
| ------------------- | ------------------ | -------------------------- |
| `TagController.php:517` | **中斷性變更**：`tagGroupLists` 的查詢參數由 `id` 改為 `group_id`。 | 若為相容舊版，建議保留 `id` 或同時支援兩者，並在 Apidoc 註明。 |
| `TagController.php:189` | `edit` 方法的驗證強制要求 `type` 為必填，但在標籤編輯情境中，類型通常不允許變更。 | 建議將 `type` 改為 `sometimes` 或從驗證中移除（若不允許修改）。 |

### 🟡 警告（建議修復）

| 檔案:行號          | 問題描述     | 建議修復           |
| ------------------ | ------------ | ------------------ |
| `TagController.php:43` | 驗證規則限制 `max:20`，但 Migration 已提升欄位長度至 50。 | 同步驗證規則至 `max:50` 以保持一致性。 |
| `TagController.php:193` | `edit` 方法的 Apidoc 缺少 `type` 參數說明，但驗證卻要求必填。 | 在 Apidoc 中新增 `type` 參數說明。 |
| `TagController.php:33` | `create` 方法的 Apidoc 包含 `id` 參數，但代碼中未使用且為自動增量。 | 移除 Apidoc 中多餘的 `id` 參數。 |

### 🔵 建議（可選修復）

| 檔案:行號          | 問題描述         | 建議修復                  |
| ------------------ | ---------------- | ------------------------- |
| `app/Services/Tags.php:267` | `getCategoryTags` 仍保留舊的範圍判定邏輯且似乎已無調用。 | 建議移除過時方法或重構為使用 `type` 欄位。 |
| `TagController.php:208` | 遍歷 `updatableKeys` 的邏輯重複出現。 | 建議提取至 Service 或使用專用的 DTO/FormRequest 處理。 |

---

## 審查結論

### 各類別評分

| 類別       | 權重 | 得分  | 狀態     | 說明 |
| ---------- | ---- | ----- | -------- | ---- |
| SOLID 原則 | 25%  | 85    | ✅ | 搜尋邏輯下沉至 Model Scope，符合 SRP。 |
| 程式碼品質 | 20%  | 90    | ✅ | 使用迴圈處理更新欄位，簡潔易維護。 |
| 功能正確性 | 15%  | 80    | ⚠️ | 存在 API 參數名稱變更導致的中斷風險。 |
| 安全性     | 15%  | 95    | ✅ | 搜尋關鍵字正確執行跳脫處理，預防 Pattern Injection。 |
| 多層架構   | 15%  | 85    | ✅ | 邏輯分配合理，Service 職責明確。 |
| 效能       | 5%   | 90    | ✅ | 新增 type 索引優化篩選效能。 |
| 可測試性   | 5%   | 80    | ✅ | 介面清晰，易於撰寫單元測試。 |

### 總分計算

**加權總分**：87 / 100

### 合併判定

| 分數區間 | 判定      | 行動             |
| -------- | --------- | ---------------- |
| 70-89    | ⚠️ 良好   | 修復警告後可合併 |

**最終結論**：⚠️ 修復後可合併
