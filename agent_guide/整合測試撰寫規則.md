## 整合測試撰寫規則

### 概述

- 需遵守整合測試的精神。
- 若撰寫的 api 中有嚴重違反 SOLID 原則時，可以簡單提出，讓我評估後續的優化方向。
- 需遵守 coding style 的規範

### 撰寫風格內容總結

#### 撰寫標準

1. **檔案結構**：每個 API 方法建立獨立的測試檔案，檔案命名格式為 `{MethodName}Test.php`
2. **檔案命名**：使用 `Test.php` 而非 `IntegrationTest.php`
3. **方法命名**：使用 snake_case 而非 camelCase
4. **常數定義**：定義 METHOD、URL 常數，建議使用 Laravel 內建的 Response::HTTP_OK 等常數
5. **錯誤處理**：業務邏輯測試驗證錯誤處理時，需使用 `resources/lang/en/error.php` 中定義的 error code
6. **屬性類型**：使用 PHP 8 屬性類型聲明
7. **Redis 清理**：在 setUp/tearDown 中清理 Redis，需確認該測試的 api 是否有使用 redis，否則不應操作 redis
8. **測試撰寫**：重點需確保 input, output 的正確，以及測試涵蓋所有商業邏輯
9. **測試資料建立**：setupTestData 時建立資料原則：應優先使用 factory 中定義的 function。
10. **測試資料使用**：撰寫測試方法時，建議優先以現有的測試資料進行修改以符合當前至測試情境，並在斷言後復原其數據，而非建立新的測試資料

#### 測試覆蓋範圍

每個測試文件包含：

- 基本驗證測試（缺少 header、無效 header）
- 參數驗證測試（必要參數、類型驗證、null 值）
- 業務邏輯測試（存在性驗證、狀態驗證）
- 成功案例測試（正常操作流程）

#### 檔案結構範例

以 `PlatformCountryController` 為例：

```
tests/Integration/PlatformCountryController/
├── ListsTest.php      # 測試 lists API
├── GetTest.php        # 測試 get API
└── UpdateTest.php     # 測試 update API
```

每個測試檔案專注於單一 API 方法的測試，提高測試的可維護性和可讀性。

#### 測試結構範例

##### 添加測試常數

```php
const METHOD = 'get';
const URL = '/api/backend/provider/platform';
```

##### 使用 PHP 8 屬性類型聲明

```php
private Providers $provider;
private Platforms $platform;
private ProviderPlatforms $providerPlatform;
```

##### 測試方法格式

- 測試方法需使用 void 類型聲明

```php
/**
 * 缺少 x-pid header
 */
public function test_missing_pid_header(): void
{
    $params = [
        'provider_id' => $this->provider->id,
        'platform_id' => $this->platform->id,
    ];

    $expectedResult = [
        'error_code' => 40001,
        'error_msg' => 'permission_denied',
    ];

    $this->assertMissingHeader(
        self::METHOD,
        self::URL,
        $params,
        'x-pid',
        Response::HTTP_UNAUTHORIZED,
        $expectedResult
    );
}
```

##### setUp/tearDown 方法

- 需確認該測試的 api 是否有使用 redis，否則不應操作 redis

```php
public function setUp(): void
{
    parent::setUp();
    $this->setUpSQLiteForTesting();
    Redis::flushdb();
    $this->setLaravelStart();
    $this->setupTestData();
}

public function tearDown(): void
{
    Redis::flushdb();
    parent::tearDown();
}
```

#### 測試風格統一

##### 參數組織方式與斷言方式

```php
$params = [
    'provider_id' => $this->provider->id,
    'platform_id' => $this->platform->id,
];

$expectedResult = [
    'error_code' => 20001,
    'error_msg' => [
        'provider_id' => [
            'The provider id field is required.'
        ]
    ]
];

$response = $this->apiRequest(self::METHOD, self::URL, $params);
$response->assertStatus(Response::HTTP_OK)
    ->assertJson($expectedResult);
```
