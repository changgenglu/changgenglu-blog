{"name":"Laravel 學習筆記.md","content":"# Laravel 學習筆記\n\n> 請先完成 laravel 環境設置\n\n>\n\n## 基礎建立\n\n- 建立新的專案\n\n  ```cmd\n  laravel new ProjectName\n  ```\n\n- 安裝指定本版\n\n  ```cmd\n  composer create-project laravel/laravel=6.* ProjectName\n  ```\n\n- 同時建立 migration controller model\n\n  ```cmd\n  php artisan make:model New -mcr\n  ```\n\n- 建立 Controller\n\n  - 控制器路徑 app/Http/controllers/NewController.php\n  - 控制器名稱字首需大寫\n\n  ```cmd\n  php artisan make:controller NewController\n  ```\n\n- 啟動 Laravel 伺服器\n\n  ```cmd\n  php artisan serve\n  ```\n\n- 使用路由\n\n  ```php\n  // routes/web.php\n  Route::get('/home/news', \"App\\Http\\Controllers\\NewController@index\");\n\n  // app/Http/controllers/NewController.php\n  public function index()\n  {\n    return \"<h1>OK</h1>\";\n  }\n  ```\n\n## 連線資料庫將資料顯示在畫面上\n\n### mysql\n\n- Laravel 資料庫設定檔 `.env`\n\n  ```php\n  APP_NAME=Laravel        （專案的名稱）\n  APP_ENV=local           （專案開發的環境，local / staging）\n  APP_KEY=                (APP KEY)\n  APP_DEBUG=true          （提供在瀏覽器中顯示詳細的錯誤訊息來進行debug）\n  APP_URL=http://localhost（專案網址，EX. http://example.com，使用方法url()時便可取得該網址）\n\n  LOG_CHANNEL=stack\n\n  DB_CONNECTION=mysql (使用的資料庫)\n  DB_HOST=127.0.0.1   (資料庫主機位置)\n  DB_PORT=3306        (資料庫的埠號)\n  DB_DATABASE=test    (資料庫名稱)\n  DB_USERNAME=        （資料庫帳號）\n  DB_PASSWORD=        （資料庫密碼）\n  ```\n\n- 建立一個 model\n\n  - model 路徑 app/Models/News.php\n\n  ```cmd\n  php artisan make:model News\n  ```\n\n- Controller 參用 News model\n\n  ```php\n  use App\\Models\\News;\n  ```\n\n- 如何把陣列顯示在前台 (回傳`json`格式)\n\n  ```php\n  public function index()\n  {\n    $dataList = News::all();\n\n    return json_encode($dataList);\n  }\n  ```\n\n- 接收 `Route::post` 的路由接引到 `store(`) 完成資料庫的新增\n\n  ```php\n  Route::post('/home/news', \"App\\Http\\Controllers\\NewController@store\");\n  ```\n\n### redis\n\n> 需先在環境安裝 redis\n\n- 安裝 `predis`\n\n  ```bash\n  composer require predis/predis\n  ```\n\n- redis 預設有 16 個資料庫，Laravel 會使用預設的資料庫`0`\n- 修改 `env`\n\n  ```config\n  REDIS_HOST=127.0.0.1\n  REDIS_PASSWORD=null\n  REDIS_PORT=6379\n  REDIS_CLIENT=predis\n  REDIS_PREFIX=\"\"\n  ```\n\n- 使用方法\n\n  ```php\n  use Illuminate\\Support\\Facades\\Redis;\n  Redis::set('name', 'Vic');\n  Redis::get('name');\n  ```\n\n- redis-cil\n\n  ```bash\n  $ redis-cli\n  $ select 0   //選擇資料庫0\n  $ keys *     //列出所有keys\n  $ get laravel_database_name  //取得key value\n  ```\n\n- 須注意 laravel 預設的 redis key 會有 `laravel_database_` 這個前綴：`$ get laravel_database_${your_key}`。這個前綴設定可以在 `env` 中的 `REDIS_PREFIX` 修改\n\n## 新增一個 html 測試`input`到資料庫\n\n- 修改 controller\n\n  ```php\n  store(Request $request){\n    $newItem = new News();\n    $newItem->title = $request->input(\"title\");\n    $newItem->title = $request->input(\"ymd\");\n    $newItem->save();\n\n    return \"進來了\";\n  }\n  ```\n\n- 修改 `VerifyCsrfToken.php`，先略過資料傳送的資安問題\n\n  - 路徑 `/home` 底下都先忽略\n\n  ```php\n  protected $except = [\n    \"/home/*\"\n  ];\n  ```\n\n- 在 model 增加\n\n  ```php\n  public $timestamps = false;\n  // redirect => 重新導向\n  ```\n\n### 將變數傳入 `view` 的三種方法\n\n1. with: 用於簡單傳遞變數，但不易擴充傳遞變數，所以不常用到\n\n   ```php\n   $name = \"test\";\n   $age = 23; \n\n   return view('my_laravel')->with('name', $name);\n   // &\n   return view('my_laravel')->with('name', $name)->with('age', $age);\n\n   // 用陣列包起來\n   $data = [\n     'name' = 'test',\n     'age'  =26\n   ];\n\n   return view('my_laravel')->with('data', $data);\n\n   // view\n   {{ $data['name'] }}\n   ```\n\n2. Array\n\n   ```php\n   $data = [\n     'name' => 'test',\n     'age' => 26\n   ]\n\n   return view('my_laravel', $data)\n\n   // view\n   {{ $name }}\n   ```\n\n3. compact\n\n   ```php\n   // 常用於複雜變數，不用包裝成新的變數名稱\n   $data = [\n     'name' => 'test',\n     'age' => 26\n   ];\n   $title = 'title';\n\n   return view('my_laravel', compact('data', 'title'));\n\n   // view\n   {{ $data['name'] }}  // 因為在 data 陣列中 \n   {{ $title }}  // 變數值直接使用\n   ```\n\n## Controller\n\n### 生成 controller\n\n```bash\nphp artisan make:controller NewController\n```\n\n- `--resource`\n\n  ```bash\n  php artisan make:controller function/NewController --resource\n  ```\n\n  - 在`function/` 的目錄下，新增一個資源控制器\n  - 生成`index()` `create()` `store()` `show()` `edit()` `update()` `destroy()`\n\n- `--api`\n\n  ```bash\n  php artisan make:controller api/NewController --api\n  ```\n\n  - 一般 api 控制器會新增在 Controller/api 的目錄之下\n  - 生成`index()` `store()` `show()` `update()` `destroy()`，省略 `create()` `edit()` 方法\n\n### resource controller function\n\n- `index()`: 顯示所有資料的列表\n\n- `create()`: 顯示新增畫面\n- `store()`: 新增資料\n- `show()`: 顯示指定 id 的資料\n- `edit()`: 顯示編輯的畫面\n- `update()`: 更新資料\n- `destroy()`: 刪除資料\n\n### controller 傳入參數\n\n一般參數\n\n```php\npublic function show($id)\n{\n   return response()->json(New::find($id), 200);\n}\n```\n\n構造函數注入(Constructor Injection)\n\n```php\npublic function show(New $new)\n{\n    return response()->json($new, 200);\n}\n```\n\n### 參數預設值\n\n當傳入 controller 的參數為空時，參數返回預設值。\n\n```php\n// route/api.php:\nRoute::post('new/{new?}', 'NewController@show');\n\n// NewController.php:\nclass NewController extends Controller\n{\n    public function show($new = \"nothing news\")\n    {\n        // ...\n    }\n}\n```\n\n## Route\n\nlaravel 中 route 有兩種:`routes/web.php` `routes/api.php`，分別為一般頁面和 api\n\n### route 基本寫法\n\n- 一般參數\n\n  ```php\n  Route::get(‘new’, ‘api\\NewController@index’);\n  Route::get(‘new/{id}’, ‘api\\NewController@show’);\n  Route::post(‘new’, ‘api\\NewController@store’);\n  Route::put(‘new/{id}’, ‘api\\NewController@update’);\n  Route::delete(‘new/{id}’, ‘api\\NewController@destroy’);\n  ```\n\n- 構造函數注入\n\n  ```php\n  Route::get(‘new’, ‘api\\NewController@index’);\n  Route::get(‘new/{new}’, ‘api\\NewController@show’);\n  Route::post(‘new’, ‘api\\NewController@store’);\n  Route::put(‘new/{new}’, ‘api\\NewController@update’);\n  Route::delete(‘new/{new}’, ‘api\\NewController@destroy’);\n  ```\n\n  - 第一個參數是對應的路徑，後面有`{}`代表傳入的參數\n  - 第二個參數是對應的 controller @後面為 controller 內要呼叫的方法\n\n### resource controller 資源控制器\n\n```php\nRoute::Resource('new', 'NewController');\n\n// api資源控制器\nRoute::apiResource('new', 'api\\NewController');\n```\n\n### route 分組\n\n- prefix: 前綴用來設定 URL 開始共同的部分。\n\n```php\nRoute::prefix(\"new\")->group(function () {\n    Route::get('view', 'NewController@show');\n    Route::post('create', 'NewController@create');\n    Route::put('update', 'NewController@edit');\n    // ...\n});\n\n```\n\n- namespace: 若要綁定的 controller 不在預設的 app/Http/Controller 裡，而是有更進一步的分類，可以設定 namespace()方便管理。\n\n```php\n// app/Http/Controller/New\nRoute::namespace(\"new\")->group(function () {\n    Route::get('new/view/{id}', 'NewController@show');\n    Route::post('new/create', 'NewController@create');\n    Route::put('new/update', 'NewController@edit');\n    // ...\n});\n```\n\n- middleware: laravel 進入 action 之前會先對 http request 進行檢查\n\n```php\nRoute::middleware('adminonly')->group(function () {\n    Route::get('new/create', 'NewController@create');\n    Route::get('new/{id}/delete', 'NewController@delete');\n    // ...\n});\n```\n\n## Laravel 功能實現\n\n### 儲存檔案並刪除舊檔\n\n```php\npublic function updateProfile(Request $request)\n{\n  $user = auth()->user();\n  // 表單驗證規則\n  $validated = $this->validateUserProfile($request->all(), $user->id)->validate();\n  if ($request->has('image')) {\n    // 取得資料表中原始資料\n    $originalData = User::find(auth()->user()->id)->getAttributes();\n    if ($originalData['image']) {\n      $filename = $originalData['image'];\n      $storage = Storage::disk('upload');\n      // 如果資料表中有紀錄，那就刪除檔案\n      if ($storage->exists($filename)) {\n        $storage->delete($filename);\n      }\n    }\n    // 原始$request['image']的值為暫存路徑，現將其改為資料表中的路徑\n    if ($request->hasFile('image')) {\n      $validated['image'] = $request->file('image')->store('images/users', 'upload');\n    }\n  }\n  $user->update($validated);\n}\n```\n\n## Class not found\n\n當出現 `Class 'xxx\\\\xxx\\\\xxx\\\\xxx' not found` 時，可能原因為 composer autoload 尚未註冊或是註冊錯誤。\n\n解決方法：\n\n- 方法一\n\n  ```terminal\n  composer dump-autoload -o\n  ```\n\n- 方法二\n\n  檢查 vendor/composer 下面的 autoload 資料夾中的檔案 autoload_classmap.php 和 autoload_static.php\n\n## 框架設計模式\n\n在小型專案中，典型的 MVC 架構沒什麼問題，但隨著系統越來越複雜，必須再細分更多層，於是衍生出 View - Presenter - Controller - Service - Repository - Model 六層框架設計模式。\n\n### 每一層的職責\n\n- Model 盡可能隱藏操作資料的 know-how，將資料抽象化，作為一個 Object Relational Mapping。\n- Repository 藉由操作 Model，幫助 Service 實現各種商務邏輯對應的資料庫操作方法。\n- Service 實現商務邏輯，並且讓 Controller 僅需要專注在溝通上。\n- Controller 作為 View 與商務邏輯間的溝通橋樑。\n- Presenter 負責 \"如何處理資料\"\n- View 負責\"要給客戶看到什麼\"\n\n### MVC 框架\n\n> 參考資料：\n>\n> [Laravel 加入 Repository 與 Service](https://vocus.cc/article/5fa7fe49fd8978000125da22)\n\n若將這六個 layer 的職責對應到 MVC 框架中，小專案下的 model 其實就是 Business Model，包含商業邏輯以及和資料庫溝通。而 View 也不會刻意把資料操作邏輯與資料處理方式獨立成一個 Presenter，因此\n小型專案的 View 往往混著一些邏輯判斷。\n\n- Model\n  - Service\n  - Repository\n  - Model\n- Controller\n  - Controller\n- View\n  - View\n  - Presenter\n\n### Web API Service\n\n通 Web API Service 僅僅是將 service 送來的資料變成 JSON format 輸出到 View 上，所以有時 Controller 就涵蓋了 Presenter 的職責，View 純粹只是 JSON, XML 等格式資料。\n\n- Model\n  - Service\n  - Repository\n  - Model\n- Controller\n  - Presenter\n  - Controller\n- View\n  - View\n","tocContent":"- [Laravel 學習筆記](#laravel-學習筆記)\n  - [基礎建立](#基礎建立)\n  - [連線資料庫將資料顯示在畫面上](#連線資料庫將資料顯示在畫面上)\n    - [mysql](#mysql)\n    - [redis](#redis)\n  - [新增一個 html 測試`input`到資料庫](#新增一個-html-測試input到資料庫)\n    - [將變數傳入 `view` 的三種方法](#將變數傳入-view-的三種方法)\n  - [Controller](#controller)\n    - [生成 controller](#生成-controller)\n    - [resource controller function](#resource-controller-function)\n    - [controller 傳入參數](#controller-傳入參數)\n    - [參數預設值](#參數預設值)\n  - [Route](#route)\n    - [route 基本寫法](#route-基本寫法)\n    - [resource controller 資源控制器](#resource-controller-資源控制器)\n    - [route 分組](#route-分組)\n  - [Laravel 功能實現](#laravel-功能實現)\n    - [儲存檔案並刪除舊檔](#儲存檔案並刪除舊檔)\n  - [Class not found](#class-not-found)\n  - [框架設計模式](#框架設計模式)\n    - [每一層的職責](#每一層的職責)\n    - [MVC 框架](#mvc-框架)\n    - [Web API Service](#web-api-service)"}