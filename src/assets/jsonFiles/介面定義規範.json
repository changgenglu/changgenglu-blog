{"name":"介面定義規範.md","content":"# 介面定義規範指南\n\n## 目錄\n- [概述](#概述)\n- [基礎規範](#基礎規範)\n- [型別宣告規範](#型別宣告規範)\n- [回傳值規範](#回傳值規範)\n- [方法命名規範](#方法命名規範)\n- [DocBlock 註解規範](#docblock-註解規範)\n- [依存關係處理](#依存關係處理)\n- [常見問題與解決方案](#常見問題與解決方案)\n- [實作範例](#實作範例)\n\n---\n\n## 概述\n\n### 介面的目的\n介面（Interface）在軟體架構中提供抽象層級，定義類別必須實作的方法契約，達成：\n1. **依賴反轉**：高階模組不依賴低階模組，兩者都依賴抽象\n2. **可替換性**：可替換實作而不影響使用方\n3. **易於測試**：可建立 mock 物件進行單元測試\n4. **程式碼重用**：透過介面統一不同實作的使用方式\n\n### 介面設計原則\n- **介面隔離原則**：介面應小而專注，而非巨集接口\n- **單一職責**：每個介面應該只負責一種類型的功能\n- **可擴展性**：介面應考慮未來可能的需求變更\n- **向後相容性**：修改介面必須考慮對現有實作的影響\n\n---\n\n## 基礎規範\n\n### 1. 介面命名規範\n\n```php\n// ✅ 正確：介面以 I 開頭\ninterface IGoogleCloudArmor\n{\n}\n\n// ✅ 也可以：明確表達用途\ninterface SecurityPolicyInterface\n{\n}\n\n// ❌ 錯誤：介面不應以 I 結尾或其他不清晰的方式命名\ninterface GoogleCloudArmorImpl\n{\n}\n```\n\n**命名建議**：\n- 以 `I` 開頭（如 `IUser`, `IGoogleCloudArmor`）\n- 或使用描述性的 Interface 後綴（如 `UserInterface`, `SecurityPolicyInterface`）\n- 保持與實作類別名稱的對應關係（如 `IGoogleCloudArmor` → `GoogleCloudArmorApi`）\n\n### 2. 介面檔案結構\n\n```php\n<?php\n\nnamespace App\\Interfaces;\n\n/**\n * Google Cloud Armor API 介面定義\n *\n * 此介面定義了與 Google Cloud Armor 服務互動所需的所有方法\n *\n * @package App\\Interfaces\n */\ninterface IGoogleCloudArmor\n{\n    /**\n     * 獲取認證令牌\n     *\n     * @return string|null 訪問令牌，失敗時返回 null\n     */\n    public function getAccessToken(): ?string;\n\n    // 其他方法...\n}\n```\n\n---\n\n## 型別宣告規範\n\n### 1. 強制型別宣告\n\n所有方法**必須**包含：\n- 參數型別宣告\n- 回傳值型別宣告\n\n```php\n// ✅ 正確：完整型別宣告\npublic function getSecurityPolicy(string $policyName): ?array;\n\n// ❌ 錯誤：缺少型別宣告\npublic function getSecurityPolicy($policyName);\n\n// ❌ 錯誤：缺少回傳值型別\npublic function getSecurityPolicy(string $policyName);\n```\n\n### 2. 支援的 PHP 型別\n\n```php\ninterface IExample\n{\n    // 標量型別\n    public function processString(string $input): string;\n    public function processInt(int $number): int;\n    public function processFloat(float $value): float;\n    public function processBool(bool $flag): bool;\n\n    // 複合型別\n    public function processArray(array $data): array;\n    public function processObject(object $obj): object;\n\n    // 可為空型別\n    public function findItem(string $id): ?Item;\n    public function getOptional(): ?string;\n\n    // 混合型別\n    public function process(mixed $data): mixed;\n\n    // 無回傳值\n    public function voidMethod(): void;\n}\n```\n\n### 3. 實作類別必須匹配\n\n```php\n// 介面定義\ninterface IExample\n{\n    public function process(string $input): string;\n}\n\n// ✅ 正確：實作完全匹配\nclass ExampleService implements IExample\n{\n    public function process(string $input): string\n    {\n        return $input;\n    }\n}\n\n// ❌ 錯誤：型別不匹配\nclass ExampleService implements IExample\n{\n    public function process($input)  // 缺少型別\n    {\n        return $input;\n    }\n}\n```\n\n---\n\n## 回傳值規範\n\n### 1. 明確的回傳值結構\n\n使用 DocBlock 明確指定回傳結構：\n\n```php\n/**\n * 獲取安全政策規則\n *\n * @param string $policyName 政策名稱\n * @return array{\n *     rules: array<int, array{\n *         priority: int,\n *         description: string,\n *         action: string,\n *         ips: array<string>\n *     }>,\n *     ips: array<string>\n * }\n */\npublic function getSecurityPolicyRules(string $policyName): array;\n```\n\n### 2. 複雜回傳值範例\n\n```php\n/**\n * 獲取格式化的安全政策規則\n *\n * @param string $policyName 政策名稱\n * @return array{\n *     all_rules: array<int, array{\n *         priority: int,\n *         description: string,\n *         action: string,\n *         ips: array<string>\n *     }>,\n *     all_ips: array<string>\n * }\n */\npublic function getFormattedSecurityPolicyRules(string $policyName): array;\n```\n\n### 3. 錯誤處理\n\n```php\n// 回傳 null 表示失敗\npublic function getSecurityPolicy(string $policyName): ?array;\n\n// 回傳空陣列表示無資料\npublic function getAllSecurityPolicies(): array;\n\n// 回傳布林表示操作成功/失敗\npublic function deleteSecurityPolicyRule(string $policyName, int $priority): bool;\n```\n\n---\n\n## 方法命名規範\n\n### 1. 動詞開頭\n\n```php\n// ✅ 正確：方法名以動詞開頭\npublic function getAccessToken(): ?string;\npublic function addSecurityPolicyRule(...): ?array;\npublic function updateSecurityPolicyRule(...): ?array;\npublic function deleteSecurityPolicyRule(...): bool;\n\n// ❌ 錯誤：方法名不應是名詞\npublic function accessToken(): ?string;\n```\n\n### 2. 動詞對應操作\n\n| 操作類型 | 動詞 | 範例 |\n|---------|------|------|\n| 獲取資料 | get, fetch, retrieve | `getSecurityPolicy()` |\n| 新增資料 | add, create, insert | `addSecurityPolicyRule()` |\n| 更新資料 | update, modify, change | `updateSecurityPolicyRule()` |\n| 刪除資料 | delete, remove, destroy | `deleteSecurityPolicyRule()` |\n| 檢查條件 | is, has, can, should | `isValid()`, `hasRule()` |\n\n### 3. 複數命名\n\n```php\n// 單數物件\npublic function getUser(int $id): User;\n\n// 複數集合\npublic function getUsers(): array;  // 回傳 User[]\n```\n\n---\n\n## DocBlock 註解規範\n\n### 1. 完整的方法註解\n\n```php\n/**\n * 方法簡述（一行描述）\n *\n * 詳細說明（多行描述，說明方法的作用、使用場景、特殊注意事項等）\n *\n * @param string $policyName 政策名稱\n * @param int $priority 優先級\n * @param string $description 規則描述\n * @param string $action 動作（allow/deny）\n * @param array<string> $ipRanges IP 範圍列表\n * @return array|null 新增的規則資料，失敗時返回 null\n * @throws \\Exception 當新增規則失敗時拋出異常\n *\n * @example\n * $result = $api->addSecurityPolicyRule(\n *     'stars',\n *     1000,\n *     '遊戲廠商-aw',\n *     'allow',\n *     ['192.168.1.1/32']\n * );\n */\npublic function addSecurityPolicyRule(\n    string $policyName,\n    int $priority,\n    string $description,\n    string $action,\n    array $ipRanges\n): ?array;\n```\n\n### 2. @param 標籤規範\n\n```php\n/**\n * @param string $policyName 政策名稱，例如 'stars' 或 'member-oversea-qc'\n * @param int $priority 優先級，數字越小優先級越高\n * @param array<string> $ips 要新增的 IP 陣列，例如 ['192.168.1.1/32', '10.0.0.1/32']\n */\n```\n\n### 3. @return 標籤規範\n\n```php\n/**\n * @return array{\n *     success: bool,\n *     total_ips: int,\n *     processed_count: int,\n *     results: array<int, array{action: string, ip: string}>\n * }\n */\n```\n\n### 4. 複雜型別註解\n\n```php\n// 多維陣列\n/**\n * @return array<int, array{id: int, name: string, active: bool}>\n */\n\n// 陣列鍵名\n/**\n * @return array<string, array{count: int, rules: array<int>}>\n */\n\n// 混合結構\n/**\n * @return array{\n *     rules: array<int, array<string, mixed>>,\n *     metadata: array<string, mixed>\n * }\n */\n```\n\n---\n\n## 依存關係處理\n\n### 1. callable 參數\n\n#### 使用 callable（簡單但型別弱）\n\n```php\n/**\n * 依描述過濾規則\n *\n * @param array $rules 所有規則\n * @param callable(string): bool $filterCallback 過濾回調函數，接收描述字串，返回是否保留\n * @return array 過濾後的規則\n */\npublic function filterRulesByDescription(array $rules, callable $filterCallback): array;\n```\n\n#### 定義專用介面（型別強，複雜度高）\n\n```php\ninterface IFilterCallback\n{\n    /**\n     * 判斷是否保留此規則\n     *\n     * @param string $description 規則描述\n     * @return bool true 表示保留，false 表示過濾\n     */\n    public function __invoke(string $description): bool;\n}\n\n/**\n * 依描述過濾規則\n *\n * @param array $rules 所有規則\n * @param IFilterCallback $filterCallback 過濾回調函數\n * @return array 過濾後的規則\n */\npublic function filterRulesByDescription(array $rules, IFilterCallback $filterCallback): array;\n```\n\n**建議**：\n- 簡單的回調：使用 `callable`\n- 複雜的回調：定義專用介面\n- 回調的參數/回傳值已在 DocBlock 說明\n\n### 2. 陣列參數\n\n```php\n/**\n * 新增 IP 到規則\n *\n * @param array<string> $ips IP 地址陣列\n */\npublic function addIps(array $ips): void;\n\n/**\n * 複雜結構陣列\n *\n * @param array<int, array{priority: int, ips: array<string>}> $rules 規則陣列\n */\npublic function processRules(array $rules): void;\n```\n\n### 3. 可選參數\n\n```php\n/**\n * 獲取安全政策\n *\n * @param string|null $policyName 政策名稱，null 表示獲取所有政策\n * @return array\n */\npublic function getSecurityPolicy(?string $policyName): array;\n\n/**\n * 使用預設值\n *\n * @param int $priority 優先級（預設為下一個可用優先級）\n */\npublic function addRule(string $name, int $priority = 0): array;\n```\n\n---\n\n## 常見問題與解決方案\n\n### 問題 1: 介面與實作型別不一致\n\n**問題描述**：\n```php\n// 介面定義\ninterface IApi\n{\n    public function getData(string $id): array;\n}\n\n// 實作類別\nclass ApiImpl implements IApi\n{\n    public function getData($id)  // 缺少型別宣告\n    {\n        // ...\n    }\n}\n```\n\n**解決方案**：\n```php\nclass ApiImpl implements IApi\n{\n    public function getData(string $id): array  // 必須包含完整型別宣告\n    {\n        // ...\n    }\n}\n```\n\n### 問題 2: 回傳值結構不明確\n\n**問題描述**：\n```php\npublic function getRules(): array;  // 不清楚回傳什麼結構\n```\n\n**解決方案**：\n```php\n/**\n * 獲取規則列表\n *\n * @return array{\n *     rules: array<int, array{priority: int, ips: array<string>}>,\n *     total: int\n * }\n */\npublic function getRules(): array;\n```\n\n### 問題 3: callable 型別過於寬泛\n\n**問題描述**：\n```php\npublic function filter(callable $callback): array;\n// 不知道 callback 的簽名\n```\n\n**解決方案**：\n```php\n/**\n * 過濾規則\n *\n * @param array $rules\n * @param callable(array, string): bool $callback\n *     - 第一個參數：規則資料\n *     - 第二個參數：規則描述\n *     - 回傳值：是否保留此規則\n * @return array\n */\npublic function filter(array $rules, callable $callback): array;\n```\n\n### 問題 4: 介面方法是否應該包含業務邏輯？\n\n**不應該**。介面僅定義契約，不包含實作：\n\n```php\n// ❌ 錯誤：介面不應包含實作\ninterface IApi\n{\n    public function process(): string\n    {\n        return 'result';  // 介面不能有實作\n    }\n}\n\n// ✅ 正確：只定義方法簽名\ninterface IApi\n{\n    public function process(): string;\n}\n```\n\n### 問題 5: 介面應該包含哪些方法？\n\n**原則**：\n- ✅ 其他類別會呼叫的方法（public 方法）\n- ✅ 需要被 mock 的依賴方法\n- ❌ 私有方法（private）\n- ❌ 僅實作內部使用的輔助方法（helper methods）\n- ❌ 不期望被外部呼叫的內部邏輯\n\n**判斷標準**：如果在測試或生產環境中，有其他類別需要呼叫這個方法，就應該在介面中定義。\n\n---\n\n## 實作範例\n\n### 完整介面範例\n\n```php\n<?php\n\nnamespace App\\Interfaces;\n\n/**\n * Google Cloud Armor API 介面定義\n *\n * 此介面定義了與 Google Cloud Armor 服務互動的所有方法\n *\n * @package App\\Interfaces\n * @author Stars Team\n * @since 1.0\n */\ninterface IGoogleCloudArmor\n{\n    /**\n     * 獲取認證令牌\n     *\n     * 從 Google Cloud 服務獲取 OAuth 2.0 訪問令牌\n     *\n     * @return string|null 訪問令牌，失敗時返回 null\n     * @throws \\Exception 當認證失敗時拋出異常\n     */\n    public function getAccessToken(): ?string;\n\n    /**\n     * 獲取所有安全政策\n     *\n     * 獲取專案中所有的安全政策及其規則\n     *\n     * @return array<int, array{\n     *     name: string,\n     *     description: string,\n     *     rules: array\n     * }> 所有安全政策列表\n     */\n    public function getSecurityPolicies(): array;\n\n    /**\n     * 獲取指定安全政策\n     *\n     * @param string $policyName 政策名稱\n     * @return array{\n     *     name: string,\n     *     description: string,\n     *     rules: array\n     * }|null 政策資料，不存在時返回 null\n     */\n    public function getSecurityPolicy(string $policyName): ?array;\n\n    /**\n     * 獲取安全政策規則\n     *\n     * @param string $policyName 政策名稱\n     * @return array{\n     *     rules: array<int, array{\n     *         priority: int,\n     *         description: string,\n     *         action: string,\n     *         ips: array<string>\n     *     }>,\n     *     ips: array<string>\n     * }\n     */\n    public function getSecurityPolicyRules(string $policyName): array;\n\n    /**\n     * 新增安全政策規則\n     *\n     * @param string $policyName 政策名稱\n     * @param int $priority 優先級\n     * @param string $description 規則描述\n     * @param string $action 動作（allow/deny）\n     * @param array<string> $ipRanges IP 範圍列表\n     * @return array|null 新增的規則資料，失敗時返回 null\n     */\n    public function addSecurityPolicyRule(\n        string $policyName,\n        int $priority,\n        string $description,\n        string $action,\n        array $ipRanges\n    ): ?array;\n\n    /**\n     * 更新安全政策規則\n     *\n     * @param string $policyName 政策名稱\n     * @param int $priority 優先級\n     * @param string $description 規則描述\n     * @param string $action 動作（allow/deny）\n     * @param array<string> $ipRanges IP 範圍列表\n     * @return array|null 更新後的規則資料\n     */\n    public function updateSecurityPolicyRule(\n        string $policyName,\n        int $priority,\n        string $description,\n        string $action,\n        array $ipRanges\n    ): ?array;\n\n    /**\n     * 刪除安全政策規則\n     *\n     * @param string $policyName 政策名稱\n     * @param int $priority 優先級\n     * @return bool 刪除成功返回 true，失敗返回 false\n     */\n    public function deleteSecurityPolicyRule(string $policyName, int $priority): bool;\n\n    /**\n     * 智慧新增 IP 到規則\n     *\n     * 自動處理每個規則最多 10 個 IP 的限制，智能分配到現有規則或建立新規則\n     *\n     * @param string $policyName 政策名稱\n     * @param array<int, array{priority: int, description: string, action: string, ips: array<string>}> $rules 現有規則陣列\n     * @param array<string> $ips 要新增的 IP 陣列\n     * @param string $baseDescription 基礎描述（用於建立新規則）\n     * @param int|null $startPriority 起始優先權（用於建立新規則）\n     * @return array<int, array{\n     *     action: string,\n     *     rule_description: string,\n     *     priority: int,\n     *     added_ips?: array<string>,\n     *     added_count?: int,\n     *     total_ips_in_rule?: int,\n     *     error?: string\n     * }> 處理結果\n     */\n    public function smartAddIpsToRules(\n        string $policyName,\n        array $rules,\n        array $ips,\n        string $baseDescription,\n        ?int $startPriority\n    ): array;\n\n    /**\n     * 智慧移除 IP 從規則\n     *\n     * 自動處理 IP 移除，當規則變空時自動刪除規則\n     *\n     * @param string $policyName 政策名稱\n     * @param array<int, array{priority: int, description: string, action: string, ips: array<string>}> $rules 現有規則陣列\n     * @param array<string> $ips 要移除的 IP 陣列\n     * @return array{\n     *     success: bool,\n     *     total_ips: int,\n     *     processed_count: int,\n     *     not_found_count: int,\n     *     processed_ips: array<string>,\n     *     not_found_ips: array<string>,\n     *     api_calls: int,\n     *     results: array\n     * }\n     */\n    public function smartRemoveIpsFromRules(\n        string $policyName,\n        array $rules,\n        array $ips\n    ): array;\n\n    /**\n     * 獲取格式化的安全政策規則\n     *\n     * @param string $policyName 政策名稱\n     * @return array{\n     *     all_rules: array<int, array{\n     *         priority: int,\n     *         description: string,\n     *         action: string,\n     *         ips: array<string>\n     *     }>,\n     *     all_ips: array<string>\n     * }\n     */\n    public function getFormattedSecurityPolicyRules(string $policyName): array;\n\n    /**\n     * 依描述過濾規則\n     *\n     * @param array<int, array{description: string}> $rules 所有規則\n     * @param callable(string): bool $filterCallback 過濾回調函數，接收描述字串，返回是否保留\n     * @return array 過濾後的規則\n     */\n    public function filterRulesByDescription(array $rules, callable $filterCallback): array;\n\n    /**\n     * 依描述分組規則\n     *\n     * @param array $rules 規則陣列\n     * @param callable(string): ?string $groupCallback 分組回調函數，接收描述字串，返回組名或 null\n     * @return array<string, array> 分組後的規則\n     */\n    public function groupRulesByDescription(array $rules, callable $groupCallback): array;\n\n    /**\n     * 依群組獲取規則\n     *\n     * @param string $policyName 政策名稱\n     * @param string $groupIdentifier 組識別符（如平台代碼）\n     * @param callable(string, string): bool $matchCallback 匹配回調函數，接收描述和識別符，返回是否匹配\n     * @return array 匹配的規則\n     */\n    public function getRulesByGroup(string $policyName, string $groupIdentifier, callable $matchCallback): array;\n}\n```\n\n### 對應的實作類別範例\n\n```php\n<?php\n\nnamespace App\\Library;\n\nuse App\\Interfaces\\IGoogleCloudArmor;\n\nclass GoogleCloudArmorApi implements IGoogleCloudArmor\n{\n    // ✅ 必須實作所有介面方法\n    public function getAccessToken(): ?string\n    {\n        // 實作...\n    }\n\n    public function getSecurityPolicies(): array\n    {\n        // 實作...\n    }\n\n    // ... 其他方法\n}\n```\n\n---\n\n## 檢查清單\n\n在設計介面時，使用此清單確認完整性：\n\n- [ ] 所有方法都有型別宣告（參數和回傳值）\n- [ ] DocBlock 完整且描述清楚\n- [ ] 回傳值結構有明確定義\n- [ ] 方法命名符合動詞開頭規範\n- [ ] 錯誤處理方式明確（null/空陣列/布林）\n- [ ] callable 參數有清楚的簽名說明\n- [ ] 沒有業務邏輯實作\n- [ ] 介面不包含私有方法\n- [ ] 介面方法是其他類別需要呼叫的方法\n- [ ] 考慮未來擴展的可能性\n\n---\n\n## 參考資源\n\n### Laravel 相關\n- [Laravel Service Container](https://laravel.com/docs/10.x/container)\n- [Laravel Testing: Mocking Objects](https://laravel.com/docs/10.x/testing#mocking-objects)\n\n### PHP 相關\n- [PHP: Type Declarations](https://www.php.net/manual/en/language.types.declarations.php)\n- [PHP: Interfaces](https://www.php.net/manual/en/language.oop5.interfaces.php)\n- [PHP: DocBlock](https://docs.phpdoc.org/3.0/guide/references/phpdoc/basic-syntax.html)\n\n### 設計模式\n- [SOLID Principles](https://en.wikipedia.org/wiki/SOLID)\n- [Dependency Inversion Principle](https://en.wikipedia.org/wiki/Dependency_inversion_principle)\n- [Interface Segregation Principle](https://en.wikipedia.org/wiki/Interface_segregation_principle)\n","tocContent":""}