{"name":"Laravel 表單驗證.md","content":"# Laravel 表單驗證\n\n## 基礎驗證方法 `validate()`\n\n```php\n$validatedData = $request->validate([\n    'title' => ['required', 'unique:posts', 'max:255'],\n    'body' => ['required'],\n]);\n```\n\n也可以使用 `validateWithBag()` 來請求驗證，並將所有錯誤訊息，儲存在一個命名錯誤訊息包\n\n```php\n$validatedData = $request->validateWithBag('post', [\n    'title' => ['required', 'unique:posts', 'max:255'],\n    'body' => ['required'],\n]);\n```\n\n在驗證規則中，加入 bail，如果某個字串在第一次驗證失敗之後，就立即停止驗證。\n\n```php\n$request->validate([\n    'title' => 'bail|required|unique:posts|max:255',\n    'body' => 'required',\n]);\n// 如果title沒通過unique的規則，那麼就不會再 繼續驗證max規則\n```\n\n如果你的 HTTP 請求，包還嵌套參數(比如陣列)，你可以在驗證規則中使用「點」語法，來指定這些參數\n\n```php\n$request->validate([\n    'title' => 'required|unique:posts|max:255',\n    'author.name' => 'required',\n    'author.description' => 'required',\n]);\n```\n\n如果你的字段名稱包含點，則可以使用跳脫符號\n\n```php\n$request->validate([\n    'title' => 'required|unique:posts|max:255',\n    'v1\\.0' => 'required',\n]);\n```\n\n## [常用規則](https://learnku.com/docs/laravel/8.x/validation/9374)\n\n## 抽取表單驗證\n\n### Form Request\n\n使用 request class 將表單驗證邏輯從 controller 中抽出\n\n1. 建立 Request class\n\n   ```bach\n       php artisan make:request RegisterRequest\n       php artisan make:request LoginRequest\n       php artisan make:request ShowUsersRequest\n       php artisan make:request UpdateUserRequest\n   ```\n\n2. 在 request class 中建立驗證邏輯\n\n   ```php\n       <?php\n\n       namespace App\\Http\\Requests;\n\n       use Illuminate\\Foundation\\Http\\FormRequest;\n\n       class RegisterRequest extends FormRequest\n       {\n           public function authorize()\n           {\n               return true;\n           }\n\n           public function rules()\n           {\n               return [\n                   'name' => 'required|string|max:255',\n                   'email' => 'required|string|email|unique:users,email',\n                   'password' => 'required|string|min:8',\n               ];\n           }\n       }\n\n   ```\n\n3. 更新 controller\n\n   ```php\n       <?php\n\n       namespace App\\Http\\Controllers;\n\n       use App\\Http\\Requests\\RegisterRequest;\n       use App\\Http\\Requests\\LoginRequest;\n       use App\\Http\\Requests\\ShowUsersRequest;\n       use App\\Http\\Requests\\UpdateUserRequest;\n       use Illuminate\\Support\\Facades\\Cache;\n       use Illuminate\\Support\\Facades\\Hash;\n       use App\\Models\\User;\n       use App\\Models\\Wallet;\n\n       class UserController extends Controller\n       {\n            public function register(RegisterRequest $request)\n           {\n               $validatedData = $request->validated();\n\n               $user = User::create([\n                   'name' => $validatedData['name'],\n                   'email' => $validatedData['email'],\n                   'password' => Hash::make($validatedData['password']),\n               ]);\n\n               $token = $user->createToken('authToken')->plainTextToken;\n\n               return response()->json([\n                   'user' => $user,\n                   'token' => $token,\n               ], 201);\n           }\n\n\n           // ... 其他方法保持不變\n       }\n\n   ```\n\n4. 集中多個請求的表單驗證\n\n   一般會建議依不同請求，個別建立單獨的 request class\n\n   ```bash\n       php artisan make:request UserRequest\n   ```\n\n5. 在此 request 中實現所有請求的驗證邏輯\n\n   ```php\n       <?php\n\n       namespace App\\Http\\Requests;\n\n       use Illuminate\\Foundation\\Http\\FormRequest;\n\n       class UserRequest extends FormRequest\n       {\n           public function authorize()\n           {\n               return true;\n           }\n\n           public function rules()\n           {\n               $method = $this->method();\n               $action = $this->route()->getActionMethod();\n\n               switch($action) {\n                   case 'register':\n                       return [\n                           'name' => 'required|string|max:255',\n                           'email' => 'required|string|email|unique:users,email',\n                           'password' => 'required|string|min:8',\n                       ];\n                   case 'login':\n                       return [\n                           'email' => 'required|string|email|exists:users,email',\n                           'password' => 'required|string',\n                       ];\n                   case 'show':\n                       return [\n                           \"item_limit\" => \"nullable|integer|min:1|max:75\",\n                           \"filter_params\" => \"nullable|array\",\n                           \"filter_params.user_balance\" => \"nullable|integer\",\n                       ];\n                   case 'update':\n                       return [\n                           'name' => 'string|max:255',\n                           'password' => 'string|min:8|nullable',\n                       ];\n                   default:\n                       return [];\n               }\n           }\n       }\n   ```\n\n優點：\n\n1. 可以在多個控制器重用相同驗證規則\n2. 可以自訂錯誤消息\n3. 可以在套用驗證規則前處理、或是在驗證後處理資料\n\n缺點：\n\n1. 對於不需要驗證使用者權限，或較單純的表單驗證而言，為每個不同的請求建立相對的 request class，顯得小題大作。\n\n### ValidatesRequests Trait\n\n自訂驗證 trait\n\n```php\nnamespace App\\Http\\Traits;\n\nuse Illuminate\\Support\\Facades\\Validator;\n\ntrait ValidatesWalletRequests\n{\n    protected function validateWalletRequest(array $data)\n    {\n        return Validator::make($data, [\n            'amount' => 'required|numeric|min:0',\n            'description' => 'required|string|max:255',\n        ]);\n    }\n}\n\n```\n\n```php\nclass WalletController extends Controller\n{\n    use ValidatesWalletRequests;\n\n    public function charge(Request $request)\n    {\n        $validator = $this->validateWalletRequest($request->all());\n        if ($validator->fails()) {\n            return response()->json($validator->errors(), 422);\n        }\n        // 繼續處理邏輯\n    }\n}\n```\n\n優點：\n\n1. 不受資料流限制，隨時可以驗證。\n2. 驗證邏輯可重用。\n3. 適合處理跨多個 controller 的通用驗證邏輯。\n\n缺點：\n\n1. 不如 form request 易用。\n2. 當專案變大時，會變的難以追蹤驗證邏輯的來源。\n\n### 結語\n\n驗證邏輯在很多情況之下，並不能完全通用，因此在 laravel 官方文件中使用 form request 來處理需要複雜表單驗證、以及使用者權限驗證的單一請求。\n若今天此一請求的表單驗證並沒有這麼複雜時，將表單驗證寫在 controller 中即可。","tocContent":""}