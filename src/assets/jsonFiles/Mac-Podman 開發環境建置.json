{"name":"Mac-Podman 開發環境建置.md","content":"# Mac Podman 開發環境建置指南\n\n## 概述\n\n本指南將在 macOS 上建立一個完整的開發環境，使用 Podman 容器化技術，包含 MySQL、Redis、PHP 多版本和 phpMyAdmin 等服務。\n\n## 環境需求\n\n- macOS (Apple Silicon 或 Intel)\n- 已安裝 Homebrew\n- 已安裝 Podman\n- 已安裝 Google Cloud SDK (用於存取私有映像檔)\n\n## 安裝步驟\n\n### 1. 安裝 Podman\n\n```bash\n# 安裝 Podman\nbrew install podman\n\n# 初始化並啟動 Podman 虛擬機\npodman machine init\npodman machine start\n\n# 驗證安裝\npodman info\n```\n\n### 2. 安裝 Google Cloud SDK\n\n```bash\n# 安裝 Google Cloud SDK\nbrew install --cask google-cloud-sdk\n\n# 重新載入 shell 配置\nsource ~/.zshrc\n\n# 初始化 gcloud (需要登入 Google 帳號)\ngcloud init\n\n# 設定專案\ngcloud config set project development-operation-center\n\n# 配置 Docker 認證\ngcloud auth configure-docker\n```\n\n### 3. 建立 Pod 容器群組\n\n```bash\npodman pod create --name dev-pod \\\n-p 8080:80 \\\n-p 3306-3310:3306-3310 \\\n-p 5001:5000 \\\n-p 5432:5432 \\\n-p 6060:6060 \\\n-p 6379:6379 \\\n-p 8000:8000 \\\n-p 8081-8082:8081-8082 \\\n-p 8084:8084 \\\n-p 11211:11211 \\\n-p 11625-11626:11625-11626 \\\n-p 27017:27017 \\\n-p 9229:9229 \\\n-p 9230:9229 \\\n-p 9231:9229\n```\n\n**注意**：端口 5000 被 macOS Control Center 佔用，因此使用 5001 替代。\n\n### 4. 建立 MySQL 容器\n\n```bash\n# 建立數據目錄\nmkdir -p ./mysql/data ./mysql/etc\n\n# 建立 MySQL 容器\npodman run -d --name mysql --pod dev-pod \\\n-e MYSQL_ROOT_PASSWORD=qwe123 \\\n-e MYSQL_DATABASE=trading_bot \\\n-e MYSQL_CHARSET=utf8mb4 \\\n-e MYSQL_COLLATION=utf8mb4_unicode_ci \\\n-v ${PWD}/mysql/data:/var/lib/mysql \\\ndocker.io/library/mysql:8.0\n```\n\n### 5. 建立 Redis 容器\n\n```bash\npodman run --pod dev-pod -d --name redis \\\n--restart=always \\\ndocker.io/library/redis:7.2.8-alpine3.21\n```\n\n### 6. 建立 phpMyAdmin 容器\n\n```bash\npodman run --pod dev-pod -d --name pma \\\n-e PMA_HOST=\"127.0.0.1\" \\\n-e PMA_USER=\"root\" \\\n-e PMA_PASSWORD='qwe123' \\\n-e UPLOAD_LIMIT='1028M' \\\n-e MEMORY_LIMIT='1028M' \\\n--restart=always \\\ndocker.io/phpmyadmin/phpmyadmin\n```\n\n### 7. 建立 PHP 容器\n\n#### PHP 8.1\n\n```bash\npodman run --pod dev-pod -d --name php81 \\\n--restart=always \\\n-e PHP_INI_POST_MAX_SIZE=\"256M\" \\\n-e UPLOAD_MAX_FILESIZE=\"200M\" \\\n-v ${PWD}:/var/www/html \\\n-w /var/www/html/ \\\ndocker.io/library/php:8.1-fpm-alpine \\\nsh -c 'while true;do sleep 30; done;'\n```\n\n#### PHP 8.3\n\n```bash\npodman run --pod dev-pod -d --name php838 \\\n--restart=always \\\n-v ${PWD}:/var/www/html \\\n-w /var/www/html/ \\\ndocker.io/library/php:8.3-fpm-alpine \\\nsh -c 'while true;do sleep 30; done;'\n```\n\n#### Node.js\n\n```bash\n# 建立 Node.js 容器\npodman run --pod dev-pod -d --name node --restart=always \\\n-e DEBUG='true' \\\n-e NODE_OPTIONS=--openssl-legacy-provider \\\n-v ${PWD}:/var/www/html \\\n-w /var/www/html/ \\\ndocker.io/library/node:18.11.0-alpine3.16 \\\nsh -c 'while true;do sleep 30; done;'\n```\n\n## 驗證安裝\n\n### 檢查容器狀態\n\n```bash\npodman ps -a\n```\n\n### 測試各項服務\n\n#### 1. 測試 phpMyAdmin\n\n```bash\ncurl -I http://localhost:8080\n```\n\n#### 2. 測試 Redis\n\n```bash\npodman exec redis redis-cli ping\n```\n\n#### 3. 測試 MySQL\n\n```bash\npodman exec mysql mysql -u root -pqwe123 -e \"SELECT VERSION();\"\n```\n\n#### 4. 測試 PHP\n\n```bash\n# PHP 8.1\npodman exec php81 php --version\n\n# PHP 8.3\npodman exec php838 php --version\n```\n\n#### 5. 測試 Node.js\n\n```bash\n# 測試 Node.js 版本\npodman exec node node --version\n\n# 測試 npm 版本\npodman exec node npm --version\n```\n\n## Git 設定與 IAP 通道\n\n### 1. 設定 SSH 金鑰\n\n```bash\n# 檢查是否已有 SSH 金鑰\nls -la ~/.ssh/\n\n# 如果沒有，生成新的 SSH 金鑰\nssh-keygen -t rsa -b 4096 -C \"your_email@example.com\"\n\n# 查看公鑰內容\ncat ~/.ssh/id_rsa.pub\n```\n\n### 2. 設定 Hosts 文件\n\n```bash\n# 將 GitLab 域名加入 hosts 文件\necho \"127.0.0.1 mars.gitlab.internal\" | sudo tee -a /etc/hosts\n```\n\n### 3. 設定 SSH 配置\n\n```bash\n# 建立 SSH 配置文件\ncat >> ~/.ssh/config << 'EOF'\n\n# GitLab Mars\nHost mars.gitlab.internal\n    HostName mars.gitlab.internal\n    Port 10022\n    User git\n    IdentityFile ~/.ssh/id_rsa\n    IdentitiesOnly yes\n    StrictHostKeyChecking no\n    UserKnownHostsFile /dev/null\n\nEOF\n```\n\n### 4. 建立 IAP 通道\n\n```bash\n# 建立 IAP 通道 (在背景運行)\ngcloud beta compute start-iap-tunnel gitlab 10022 \\\n--local-host-port=localhost:10022 \\\n--zone=asia-east1-a &\n\n# 檢查通道狀態\nnetstat -an | grep 10022\n```\n\n### 5. 測試 Git 連接\n\n```bash\n# 測試 SSH 連接\nssh -T mars.gitlab.internal\n\n# 如果成功，會看到類似訊息：\n# Welcome to GitLab, @username!\n```\n\n### 6. 將 SSH 公鑰添加到 GitLab\n\n1. 複製 SSH 公鑰：\n\n   ```bash\n   cat ~/.ssh/id_rsa.pub | pbcopy\n   ```\n\n2. 登入 GitLab：https://gitlab-v1-mars.9alaxy.com/\n3. 進入 Settings → SSH Keys\n4. 貼上公鑰並保存\n\n## 服務配置\n\n### 端口對應表\n\n| 服務       | 容器端口 | 主機端口  | 說明           |\n| ---------- | -------- | --------- | -------------- |\n| phpMyAdmin | 80       | 8080      | 資料庫管理介面 |\n| MySQL      | 3306     | 3306-3310 | 資料庫服務     |\n| Redis      | 6379     | 6379      | 快取服務       |\n| PHP        | 9000     | -         | PHP-FPM        |\n\n### 資料庫連接資訊\n\n- **MySQL**：\n\n  - 主機：`localhost`\n  - 端口：`3306`\n  - 用戶名：`root`\n  - 密碼：`qwe123`\n  - 資料庫：`trading_bot`\n\n- **Redis**：\n\n  - 主機：`localhost`\n  - 端口：`6379`\n\n- **phpMyAdmin**：\n  - 網址：http://localhost:8080\n  - 用戶名：`root`\n  - 密碼：`qwe123`\n\n## 使用方式\n\n### 進入容器\n\n```bash\n# 進入 PHP 8.1 容器\npodman exec -it php81 sh\n\n# 進入 PHP 8.3 容器\npodman exec -it php838 sh\n\n# 進入 MySQL 容器\npodman exec -it mysql bash\n\n# 進入 Redis 容器\npodman exec -it redis sh\n\n# 進入 Node.js 容器\npodman exec -it node sh\n```\n\n### Git 操作\n\n```bash\n# 確保 IAP 通道運行\ngcloud beta compute start-iap-tunnel gitlab 10022 \\\n--local-host-port=localhost:10022 \\\n--zone=asia-east1-a &\n\n# 克隆專案\ngit clone mars.gitlab.internal:group/project.git\n\n# 測試 Git 連接\nssh -T mars.gitlab.internal\n```\n\n### Node.js 環境建置\n\n#### 安裝 pnpm\n\n在 Node.js 容器的 `/var/www/html` 目錄中執行：\n\n```bash\n# 進入 Node.js 容器\npodman exec -it node sh\n\n# 安裝 pnpm\nnpm install -g pnpm@8.10.5\n```\n\n#### 安裝專案套件\n\n```bash\n# 在專案目錄下執行\npnpm install\n```\n\n#### 啟動專案\n\n```bash\n# puppy 本地的執行語法\nENV=local pnpm run start\n```\n\n### 管理 Pod\n\n```bash\n# 查看 Pod 狀態\npodman pod list\n\n# 停止 Pod\npodman pod stop dev-pod\n\n# 啟動 Pod\npodman pod start dev-pod\n\n# 重啟 Pod\npodman pod restart dev-pod\n\n# 刪除 Pod (會刪除所有容器)\npodman pod rm -f dev-pod\n```\n\n### 管理個別容器\n\n```bash\n# 查看所有容器\npodman ps -a\n\n# 停止容器\npodman stop <container_name>\n\n# 啟動容器\npodman start <container_name>\n\n# 重啟容器\npodman restart <container_name>\n\n# 刪除容器\npodman rm <container_name>\n```\n\n## 檔案掛載\n\n- **當前目錄**：`/Users/changgenglu/Documents` 已掛載到所有 PHP 容器的 `/var/www/html`\n- **MySQL 數據**：`./mysql/data` 目錄用於持久化 MySQL 數據\n\n## 常見問題\n\n### 1. 端口衝突\n\n如果遇到端口被佔用的問題：\n\n```bash\n# 查看端口使用情況\nlsof -i :<port_number>\n\n# 修改 Pod 配置中的端口映射\n```\n\n### 2. 容器無法啟動\n\n```bash\n# 查看容器日誌\npodman logs <container_name>\n\n# 檢查 Pod 狀態\npodman pod inspect dev-pod\n```\n\n### 3. 權限問題\n\n```bash\n# 確保數據目錄有正確權限\nchmod -R 755 ./mysql/data\n```\n\n### 4. IAP 通道問題\n\n```bash\n# 檢查 IAP 通道是否運行\nps aux | grep iap-tunnel\n\n# 重新啟動 IAP 通道\npkill -f iap-tunnel\ngcloud beta compute start-iap-tunnel gitlab 10022 \\\n--local-host-port=localhost:10022 \\\n--zone=asia-east1-a &\n\n# 檢查端口是否監聽\nnetstat -an | grep 10022\n```\n\n### 5. Git 連接問題\n\n```bash\n# 檢查 SSH 配置\ncat ~/.ssh/config\n\n# 測試 SSH 連接\nssh -T mars.gitlab.internal\n\n# 檢查 hosts 文件\ncat /etc/hosts | grep mars\n```\n\n## 清理環境\n\n如果需要完全清理環境：\n\n```bash\n# 停止並刪除 Pod\npodman pod rm -f dev-pod\n\n# 刪除數據目錄\nrm -rf ./mysql/data\n\n# 清理未使用的映像檔\npodman image prune -a\n```\n\n## 進階配置\n\n### 自定義 PHP 配置\n\n可以在 PHP 容器中安裝額外的擴展：\n\n```bash\n# 進入 PHP 容器\npodman exec -it php81 sh\n\n# 安裝 PHP 擴展\napk add --no-cache php8-mysql php8-redis php8-mbstring\n```\n\n### 環境變數配置\n\n可以通過環境變數來配置各個服務：\n\n```bash\n# 在建立容器時添加環境變數\n-e ENV_VAR_NAME=value\n```\n\n## 總結\n\n這個環境提供了：\n\n- ✅ MySQL 8.0 資料庫\n- ✅ Redis 快取服務\n- ✅ Memcached 快取服務\n- ✅ PHP 8.1 和 8.3 多版本支援\n- ✅ Node.js 18.11.0 環境\n- ✅ phpMyAdmin 資料庫管理介面\n- ✅ 完整的端口映射配置\n- ✅ 檔案掛載支援\n- ✅ Google Cloud SDK 整合\n- ✅ IAP 通道連接到內部 GitLab\n- ✅ SSH 金鑰認證設定\n\n環境已準備就緒，可以開始開發工作！\n\n## 重要提醒\n\n- **IAP 通道**：每次重開機後需要重新啟動 IAP 通道\n- **容器重啟**：所有容器都會自動重啟\n- **檔案同步**：當前目錄的檔案會即時同步到容器中\n- **Git 操作**：需要確保 IAP 通道運行才能進行 Git 操作\n","tocContent":""}