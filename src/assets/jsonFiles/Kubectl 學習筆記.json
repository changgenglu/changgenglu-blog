{"name":"Kubectl 學習筆記.md","content":"# Kubectl 學習筆記\n\n> 本文件記錄 Kubernetes kubectl 命令的使用方法與 Pod 網路連線測試技巧\n\n>\n\n## 基礎概念\n\n本文件說明如何使用 `curl` 命令測試 Kubernetes 環境中 Pod 間的網路連線效能和延遲。透過系統性的測試方法，可以有效診斷和分析 Pod 間的網路狀況。\n\n## curl 效能測試命令\n\n### 基本命令結構\n\n```bash\ncurl -v -w \"\\n=== Timing Analysis ===\\nDNS Lookup: %{time_namelookup}s\\nTCP Connect: %{time_connect}s\\nSSL Handshake: %{time_appconnect}s\\nTime to First Byte: %{time_starttransfer}s\\nTotal Time: %{time_total}s\\n\" https://example.com/api/endpoint\n```\n\n### 參數說明\n\n| 參數 | 功能 | 描述 |\n|------|------|------|\n| `-v` | Verbose | 顯示詳細的請求和回應資訊，包括標頭、SSL 憑證等 |\n| `-w` | Write-out | 自訂輸出格式，顯示指定的測量數據 |\n\n### 時間測量指標\n\n| 指標 | 變數 | 說明 |\n|------|------|------|\n| DNS Lookup | `%{time_namelookup}` | 域名解析為 IP 位址所需時間 |\n| TCP Connect | `%{time_connect}` | TCP 連線建立時間（三次握手） |\n| SSL Handshake | `%{time_appconnect}` | SSL/TLS 握手時間（HTTPS 時） |\n| Time to First Byte | `%{time_starttransfer}` | 從請求開始到接收第一個位元組的時間 |\n| Total Time | `%{time_total}` | 整個請求過程的總時間 |\n\n## Kubernetes 環境中的 Pod 間連線測試\n\n### 準備工作\n\n#### 確認 Pod 和 Service 資訊\n\n```bash\n# 查看所有 namespace\nkubectl get namespaces\n\n# 查看指定 namespace 中的 pods\nkubectl get pods -n <namespace> -o wide\n\n# 查看指定 namespace 中的 services\nkubectl get svc -n <namespace>\n```\n\n#### 查看 Pod 分佈和節點資訊\n\n```bash\n# 查看 Pod 在不同節點的分佈情況\nkubectl get pods -n <namespace> -o wide --sort-by=.spec.nodeName\n```\n\n### 測試方法\n\n#### 使用 Service 名稱測試（推薦）\n\n```bash\n# 基本語法\nkubectl exec -n <namespace> <source-pod> -- curl -v -w \"\\n=== Timing Analysis ===\\nDNS Lookup: %{time_namelookup}s\\nTCP Connect: %{time_connect}s\\nSSL Handshake: %{time_appconnect}s\\nTime to First Byte: %{time_starttransfer}s\\nTotal Time: %{time_total}s\\n\" http://<target-service>:<port>/\n\n# 範例\nkubectl exec -n backend stars-cron-backend-78c97498b8-7v62k -- curl -v -w \"\\n=== Timing Analysis ===\\nDNS Lookup: %{time_namelookup}s\\nTCP Connect: %{time_connect}s\\nSSL Handshake: %{time_appconnect}s\\nTime to First Byte: %{time_starttransfer}s\\nTotal Time: %{time_total}s\\n\" http://stars-backend:80/\n```\n\n#### 使用 Pod IP 直接測試\n\n```bash\n# 直接使用 Pod IP 測試（跳過 DNS 解析和 LoadBalancer）\nkubectl exec -n <namespace> <source-pod> -- curl -v -w \"\\n=== Timing Analysis ===\\nDNS Lookup: %{time_namelookup}s\\nTCP Connect: %{time_connect}s\\nSSL Handshake: %{time_appconnect}s\\nTime to First Byte: %{time_starttransfer}s\\nTotal Time: %{time_total}s\\n\" http://<target-pod-ip>:<port>/\n```\n\n#### 使用 Service IP 測試\n\n```bash\n# 使用 Service 的 Cluster IP 測試（跳過 DNS 解析）\nkubectl exec -n <namespace> <source-pod> -- curl -v -w \"\\n=== Timing Analysis ===\\nDNS Lookup: %{time_namelookup}s\\nTCP Connect: %{time_connect}s\\nSSL Handshake: %{time_appconnect}s\\nTime to First Byte: %{time_starttransfer}s\\nTotal Time: %{time_total}s\\n\" http://<service-cluster-ip>:<port>/\n```\n\n### 效能比較測試\n\n#### 簡化版本（只顯示總時間）\n\n```bash\n# 測試 Service 名稱\nkubectl exec -n <namespace> <source-pod> -- curl -s -w \"Service DNS: %{time_total}s\\n\" -o /dev/null http://<service-name>:<port>/\n\n# 測試 Service IP\nkubectl exec -n <namespace> <source-pod> -- curl -s -w \"Service IP: %{time_total}s\\n\" -o /dev/null http://<service-ip>:<port>/\n\n# 測試 Pod IP\nkubectl exec -n <namespace> <source-pod> -- curl -s -w \"Pod IP: %{time_total}s\\n\" -o /dev/null http://<pod-ip>:<port>/\n```\n\n#### 批次測試\n\n```bash\n# 執行多次測試取平均值\nfor i in {1..10}; do\n  kubectl exec -n <namespace> <source-pod> -- curl -s -w \"%{time_total}\\n\" -o /dev/null http://<target>:<port>/\ndone\n```\n\n#### 跨節點 vs 同節點效能比較\n\n```bash\n# 測試跨節點連線\nkubectl exec -n <namespace> <source-pod> -- curl -s -w \"跨節點: %{time_total}s\\n\" -o /dev/null http://<cross-node-pod-ip>:<port>/\n\n# 測試同節點連線\nkubectl exec -n <namespace> <source-pod> -- curl -s -w \"同節點: %{time_total}s\\n\" -o /dev/null http://<same-node-pod-ip>:<port>/\n```\n\n### 故障排除\n\n#### DNS 解析問題\n\n```bash\n# 檢查 DNS 解析\nkubectl exec -n <namespace> <pod-name> -- nslookup <service-name>\n\n# 檢查 DNS 設定\nkubectl exec -n <namespace> <pod-name> -- cat /etc/resolv.conf\n\n# 使用完整 FQDN\nkubectl exec -n <namespace> <pod-name> -- curl http://<service-name>.<namespace>.svc.cluster.local:<port>/\n```\n\n#### 檢查 Pod 工具可用性\n\n```bash\n# 檢查 curl 是否可用\nkubectl exec -n <namespace> <pod-name> -- which curl\n\n# 如果沒有 curl，使用 wget\nkubectl exec -n <namespace> <pod-name> -- wget -O- --server-response http://<target>:<port>/\n```\n\n#### 檢查網路政策\n\n```bash\n# 檢查 NetworkPolicy\nkubectl get networkpolicy -n <namespace>\n\n# 檢查 Pod 標籤\nkubectl get pods -n <namespace> --show-labels\n```\n\n### 最佳實踐\n\n1. **測試順序建議**：\n   - 先測試 Service 名稱（完整路徑）\n   - 再測試 Service IP（跳過 DNS）\n   - 最後測試 Pod IP（跳過 LoadBalancer）\n\n2. **效能基準**：\n   - 同節點 Pod 間通訊：< 5ms\n   - 跨節點 Pod 間通訊：< 10ms\n   - DNS 解析：< 5ms\n\n3. **測試建議**：\n   - 執行多次測試取平均值\n   - 測試不同時間點的效能\n   - 記錄測試環境和條件\n\n## 常見問題\n\n### Q1: 出現 \"Could not resolve host\" 錯誤\n\n**A**: 檢查 Service 名稱是否正確，或嘗試使用完整 FQDN 格式\n\n### Q2: 連線被拒絕\n\n**A**: 檢查目標 Pod 是否正在運行，端口是否正確\n\n### Q3: 時間測量都是 0\n\n**A**: 可能是連線失敗，檢查網路政策和防火牆設定\n\n### Q4: 效能差異很大\n\n**A**: 考慮網路負載、Pod 資源使用情況和節點間網路狀況\n\n","tocContent":"- [Kubectl 學習筆記](#kubectl-學習筆記)\n  - [基礎概念](#基礎概念)\n  - [curl 效能測試命令](#curl-效能測試命令)\n    - [基本命令結構](#基本命令結構)\n    - [參數說明](#參數說明)\n    - [時間測量指標](#時間測量指標)\n  - [Kubernetes 環境中的 Pod 間連線測試](#kubernetes-環境中的-pod-間連線測試)\n    - [準備工作](#準備工作)\n      - [確認 Pod 和 Service 資訊](#確認-pod-和-service-資訊)\n      - [查看 Pod 分佈和節點資訊](#查看-pod-分佈和節點資訊)\n    - [測試方法](#測試方法)\n      - [使用 Service 名稱測試（推薦）](#使用-service-名稱測試推薦)\n      - [使用 Pod IP 直接測試](#使用-pod-ip-直接測試)\n      - [使用 Service IP 測試](#使用-service-ip-測試)\n    - [效能比較測試](#效能比較測試)\n      - [簡化版本（只顯示總時間）](#簡化版本只顯示總時間)\n      - [批次測試](#批次測試)\n      - [跨節點 vs 同節點效能比較](#跨節點-vs-同節點效能比較)\n    - [故障排除](#故障排除)\n      - [DNS 解析問題](#dns-解析問題)\n      - [檢查 Pod 工具可用性](#檢查-pod-工具可用性)\n      - [檢查網路政策](#檢查網路政策)\n    - [最佳實踐](#最佳實踐)\n  - [常見問題](#常見問題)\n    - [Q1: 出現 \"Could not resolve host\" 錯誤](#q1-出現-could-not-resolve-host-錯誤)\n    - [Q2: 連線被拒絕](#q2-連線被拒絕)\n    - [Q3: 時間測量都是 0](#q3-時間測量都是-0)\n    - [Q4: 效能差異很大](#q4-效能差異很大)"}