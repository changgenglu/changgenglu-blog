alias pm='podman'
alias init='sh ~/restartPod.sh'
alias ll='ls -al'
alias cursor='/mnt/c/Users/ivan.ma/AppData/Local/Programs/cursor/resources/app/bin/cursor'
alias anti='/mnt/c/Users/ivan.ma/AppData/Local/Programs/Antigravity/bin/antigravity'
alias php8='podman exec -it stars sh'
alias php838='podman exec -it backend838 sh'
alias node='podman exec -it node sh'

## set env

function gotoDev() {
  gcloud container clusters get-credentials web-v1 --region asia-east1 --project gotomercury-460707
}

function gotoMars() {
  gcloud container clusters get-credentials web-v2 --region asia-east1 --project development-operation-center
}

function gotoVenus() {
  gcloud container clusters get-credentials web-v2 --region asia-east1 --project gotovenus
}

## --- tmp pod v3.1 (Auto-Tag + Custom Pod Name) ---

DEFAULT_NS="tmp"

function _getProjectId() {
  case "${1}" in
    "dev"|"mercury") echo "gotomercury-460707" ;;
    "mars"|"staging") echo "development-operation-center" ;;
    "venus"|"prod") echo "gotovenus" ;;
    *) echo "" ;;
  esac
}

function _getImageTag() {
  local inputTag="${1}"
  local envName="${2}"
  local imageName="${3}"

  # 1. å¦‚æœ CLI åƒæ•¸æœ‰å¸¶ Tag (æˆ–æ˜¯è¼¸å…¥ "auto")
  if [ -n "$inputTag" ] && [ "$inputTag" != "auto" ]; then
    echo "$inputTag"
    return 0
  fi

  # 2. å¦‚æœæ˜¯ "auto" æˆ–ç©ºå€¼ï¼Œæº–å‚™é€²è¡Œè‡ªå‹•ç²å–
  # å¦‚æœæ˜¯ç©ºå€¼ï¼Œå…ˆçµ¦ä½¿ç”¨è€…ä¸€å€‹ç¢ºèª/è¼¸å…¥çš„æ©Ÿæœƒ
  if [ -z "$inputTag" ]; then
    echo -n "ğŸ·ï¸  è«‹è¼¸å…¥ image-tag (é è¨­: è‡ªå‹•ç²å–æœ€æ–°ç‰ˆ): " >&2
    read inputTag
  fi

  # å¦‚æœä½¿ç”¨è€…è¼¸å…¥äº†ç‰¹å®š tagï¼Œå°±ç”¨è¼¸å…¥çš„
  if [ -n "$inputTag" ]; then
    echo "$inputTag"
    return 0
  fi

  # 3. åŸ·è¡Œ gcloud è‡ªå‹•ç²å–
  echo "ğŸ” æ­£åœ¨æœå°‹ ${envName} ç’°å¢ƒä¸­ ${imageName} çš„æœ€æ–° Tag..." >&2
  local projectId
  projectId=$(_getProjectId "${envName}")

  if [ -z "$projectId" ]; then
    echo "âŒ éŒ¯èª¤: ç„¡æ³•ç¢ºèª Project IDï¼Œè«‹æ‰‹å‹•è¼¸å…¥ Tag" >&2
    return 1
  fi

  # æ ¹æ“šç’°å¢ƒæ±ºå®š tag æ ¼å¼
  local tagPattern
  case "${envName}" in
    "venus"|"prod")
      # venus ç’°å¢ƒä½¿ç”¨æ–°æ ¼å¼: v20260114001-20260114100454
      tagPattern='^v[0-9]+-[0-9]+$'
      ;;
    *)
      # dev å’Œ mars ç’°å¢ƒä½¿ç”¨èˆŠæ ¼å¼: 20251230103103
      tagPattern='^[0-9]+$'
      ;;
  esac

  local latestTag
  latestTag=$(gcloud artifacts docker tags list "asia-docker.pkg.dev/${projectId}/asia.gcr.io/${imageName}" \
    --format="value(tag)" \
    --sort-by="~tag" 2>/dev/null | grep -E "${tagPattern}" | head -1)

  if [ -z "$latestTag" ]; then
    echo "âŒ éŒ¯èª¤: æ‰¾ä¸åˆ° ${imageName} çš„æœ€æ–° Tagï¼Œè«‹æª¢æŸ¥ gcloud ç™»å…¥ç‹€æ…‹æˆ–æ‰‹å‹•è¼¸å…¥" >&2
    return 1
  fi

  echo "âœ… ç²å–æˆåŠŸ: ${latestTag}" >&2
  echo "$latestTag"
}

# [ä¿®æ”¹é‡é»] æ¢å¾©äº’å‹•è¼¸å…¥ï¼Œä½†ä¿ç•™è‡ªå‹•ç”¢ç”Ÿä½œç‚º Default
function _getPodName() {
  local inputName="${1}"
  local defaultName="debug-$(date +%s | tail -c 5)"

  # 1. å¦‚æœ CLI æœ‰å‚³å…¥åƒæ•¸ï¼Œç›´æ¥ä½¿ç”¨
  if [ -n "$inputName" ]; then
    echo "$inputName"
    return 0
  fi

  # 2. å¦‚æœæ²’å‚³åƒæ•¸ï¼Œè®“ä½¿ç”¨è€…è¼¸å…¥ï¼Œä¸¦é¡¯ç¤ºé è¨­å€¼
  echo -n "ğŸ”§ è«‹è¼¸å…¥ pod name (é è¨­: ${defaultName}): " >&2
  read inputName

  if [ -n "$inputName" ]; then
    echo "$inputName"
  else
    echo "$defaultName"
  fi
}

function _buildPodCommand() {
  local image="${1}"
  local podName="${2}"
  local ans

  echo "--------------------------------------------------"
  echo "ğŸš€ æº–å‚™åŸ·è¡Œ Pod (Namespace: ${DEFAULT_NS})"
  echo "ğŸ“¦ Image: ${image}"
  echo "ğŸ”§ Pod  : ${podName}"
  echo "--------------------------------------------------"
  echo -n "ç¢ºèªåŸ·è¡Œï¼Ÿ [y/N]: "
  read ans

  if [[ "$ans" =~ ^[Yy]$ ]]; then
      kubectl -n "${DEFAULT_NS}" run --rm -it --restart=Never --image="${image}" "${podName}" -- sh
  else
      echo "ğŸš« å·²å–æ¶ˆ"
  fi
}

function _getEnv() {
  local env="${1}"
  if [ -z "$env" ]; then
    echo "ğŸŒ è«‹é¸æ“‡ç’°å¢ƒ:" >&2
    echo "  1) dev (gotomercury-460707)" >&2
    echo "  2) mars (development-operation-center)" >&2
    echo "  3) venus (gotovenus)" >&2
    echo -n "è«‹è¼¸å…¥é¸é … [1-3]: " >&2
    read choice
    
    case "$choice" in
      1) env="dev" ;;
      2) env="mars" ;;
      3) env="venus" ;;
      *) 
        echo "âŒ éŒ¯èª¤: ç„¡æ•ˆçš„é¸é …" >&2
        return 1
        ;;
    esac
  fi
  
  # é©—è­‰ç’°å¢ƒåç¨±
  case "$env" in
    "dev"|"mercury"|"mars"|"staging"|"venus"|"prod")
      echo "$env"
      ;;
    *)
      echo "âŒ éŒ¯èª¤: ç„¡æ•ˆçš„ç’°å¢ƒåç¨±" >&2
      return 1
      ;;
  esac
}

function _getProject() {
  local proj="${1}"
  if [ -z "$proj" ]; then
    echo "ğŸ—ï¸  è«‹é¸æ“‡å°ˆæ¡ˆ:" >&2
    echo "  1) stars" >&2
    echo "  2) satellite" >&2
    echo "  3) cron" >&2
    echo "  4) eagle" >&2
    echo -n "è«‹è¼¸å…¥é¸é … [1-4]: " >&2
    read choice
    
    case "$choice" in
      1) proj="stars" ;;
      2) proj="satellite" ;;
      3) proj="cron" ;;
      4) proj="eagle" ;;
      *) 
        echo "âŒ éŒ¯èª¤: ç„¡æ•ˆçš„é¸é …" >&2
        return 1
        ;;
    esac
  fi
  
  echo "$proj"
}

function _resolveRegistry() {
  case "${1}" in
    "dev") echo "asia.gcr.io/gotomercury-460707" ;;
    "mars") echo "asia.gcr.io/development-operation-center" ;;
    "venus") echo "asia.gcr.io/gotovenus" ;;
    *) echo "" ;;
  esac
}

function _getProjectImageName() {
  case "${1}" in
    "star"|"stars") echo "stars" ;;
    "satel"|"satellite") echo "satellite" ;;
    "cron") echo "cron" ;;
    "ego"|"eagle") echo "eagle" ;;
    *) echo "${1}" ;;
  esac
}

function _runTmp() {
  local envName
  envName=$(_getEnv "${1}") || return 1

  local projNameInput
  projNameInput=$(_getProject "${2}") || return 1

  local projImageName
  projImageName=$(_getProjectImageName "${projNameInput}")

  local tag
  tag=$(_getImageTag "${3}" "${envName}" "${projImageName}") || return 1

  local podName
  podName=$(_getPodName "${4}")

  local registry
  registry=$(_resolveRegistry "${envName}")

  if [ -z "$registry" ]; then
    echo "âŒ éŒ¯èª¤: æœªçŸ¥çš„ç’°å¢ƒ ${envName}" >&2
    return 1
  fi

  _buildPodCommand "${registry}/${projImageName}:${tag}" "${podName}"
}

## --- create tmp alias ---

# ä½¿ç”¨æ–¹å¼:
# 1. newTmpPod -h                     (é¡¯ç¤ºä½¿ç”¨èªªæ˜)
# 2. newTmpPod                         (äº’å‹•æ¨¡å¼: é¸æ“‡ç’°å¢ƒã€å°ˆæ¡ˆã€Tag å’Œ Pod Name)
# 3. newTmpPod dev stars               (äº’å‹•è©¢å• Tag å’Œ Pod Name)
# 4. newTmpPod dev stars "" my-pod     (è‡ªå‹• Tag, æŒ‡å®š Pod Name)
# 5. newTmpPod dev stars auto my-pod   (è‡ªå‹• Tag, æŒ‡å®š Pod Name)
function newTmpPod() {
  # é¡¯ç¤ºå¹«åŠ©è¨Šæ¯
  if [ "${1}" = "-h" ] || [ "${1}" = "--help" ]; then
    echo "ğŸ“š newTmpPod - å»ºç«‹è‡¨æ™‚ Kubernetes Pod"
    echo ""
    echo "ç”¨æ³•:"
    echo "  newTmpPod [ç’°å¢ƒ] [å°ˆæ¡ˆ] [tag] [podåç¨±]"
    echo ""
    echo "åƒæ•¸:"
    echo "  ç’°å¢ƒ     - dev, mars, venus (å¯é¸ï¼Œä¸æä¾›å‰‡äº’å‹•é¸æ“‡)"
    echo "  å°ˆæ¡ˆ     - stars, satellite, cron, eagle (å¯é¸ï¼Œä¸æä¾›å‰‡äº’å‹•é¸æ“‡)"
    echo "  tag      - image tag æˆ– 'auto' è‡ªå‹•ç²å– (å¯é¸ï¼Œä¸æä¾›å‰‡äº’å‹•è¼¸å…¥)"
    echo "  podåç¨±  - è‡ªè¨‚ pod åç¨± (å¯é¸ï¼Œä¸æä¾›å‰‡äº’å‹•è¼¸å…¥æˆ–è‡ªå‹•ç”Ÿæˆ)"
    echo ""
    echo "ç¯„ä¾‹:"
    echo "  newTmpPod                        # å®Œå…¨äº’å‹•æ¨¡å¼"
    echo "  newTmpPod dev stars              # äº’å‹•è©¢å• tag å’Œ pod åç¨±"
    echo "  newTmpPod dev stars auto         # è‡ªå‹•ç²å– tagï¼Œäº’å‹•è¼¸å…¥ pod åç¨±"
    echo "  newTmpPod dev stars auto my-pod  # è‡ªå‹•ç²å– tagï¼ŒæŒ‡å®š pod åç¨±"
    echo "  newTmpPod venus satellite 12345  # æŒ‡å®š tagï¼Œäº’å‹•è¼¸å…¥ pod åç¨±"
    echo ""
    echo "ç’°å¢ƒå°æ‡‰:"
    echo "  dev   â†’ gotomercury-460707"
    echo "  mars  â†’ development-operation-center"
    echo "  venus â†’ gotovenus"
    return 0
  fi
  
  _runTmp "${1}" "${2}" "${3}" "${4}";
}

function findMyBranches() {
# é€™å€‹è…³æœ¬æœƒè‡ªå‹•ç²å–ç•¶å‰ Git ä½¿ç”¨è€…çš„ emailï¼Œä¸¦æœå°‹è©²ä½¿ç”¨è€…çš„æ‰€æœ‰é ç«¯åˆ†æ”¯

# ç²å–ç•¶å‰ Git ä½¿ç”¨è€…çš„ email åœ°å€
current_email=$(git config user.email)

# æª¢æŸ¥æ˜¯å¦æˆåŠŸç²å–åˆ°ä½¿ç”¨è€… email
if [ -z "$current_email" ]; then
    echo "éŒ¯èª¤ï¼šç„¡æ³•ç²å– Git ä½¿ç”¨è€… email"
    echo "è«‹ç¢ºèªä½ å·²ç¶“è¨­å®šäº† Git ä½¿ç”¨è€… emailï¼š"
    echo "git config --global user.email \"your.email@example.com\""
    exit 1
fi

echo "æ­£åœ¨æœå°‹ email '$current_email' çš„åˆ†æ”¯..."
echo "----------------------------------------"

# ä½¿ç”¨ '%ae' ä¾†ç²å–ä½œè€…çš„ email åœ°å€
git -c diff.renameLimit=1889 for-each-ref --format='%(refname:short) %(creator)' 'refs/remotes' | \
    while read -r branch creator; do
        author_email=$(git log -1 --format='%ae' "$branch")
        if [ "$author_email" = "$current_email" ]; then
            author_name=$(git log -1 --format='%an' "$branch")
            printf "Branch: %s\nAuthor: %s <%s>\n\n" \
                "$branch" \
                "$author_name" \
                "$author_email"
        fi
    done
}

## --- list all pods ---

# ä½¿ç”¨æ–¹å¼:
# 1. getPods -h        (é¡¯ç¤ºä½¿ç”¨èªªæ˜)
# 2. getPods           (åˆ—å‡º backend namespace çš„ pods)
# 3. getPods tmp       (åˆ—å‡º tmp namespace çš„ pods)
# 4. getPods all       (åˆ—å‡ºæ‰€æœ‰ namespace çš„ pods)
function getPods() {
  # é¡¯ç¤ºå¹«åŠ©è¨Šæ¯
  if [ "${1}" = "-h" ] || [ "${1}" = "--help" ]; then
    echo "ğŸ“š getPods - åˆ—å‡º Kubernetes Pods"
    echo ""
    echo "ç”¨æ³•:"
    echo "  getPods [namespace]"
    echo ""
    echo "åƒæ•¸:"
    echo "  namespace - å‘½åç©ºé–“åç¨± (å¯é¸ï¼Œé è¨­: backend)"
    echo "              ä½¿ç”¨ 'all' åˆ—å‡ºæ‰€æœ‰å‘½åç©ºé–“çš„ pods"
    echo ""
    echo "ç¯„ä¾‹:"
    echo "  getPods          # åˆ—å‡º backend namespace çš„ pods"
    echo "  getPods tmp      # åˆ—å‡º tmp namespace çš„ pods"
    echo "  getPods default  # åˆ—å‡º default namespace çš„ pods"
    echo "  getPods all      # åˆ—å‡ºæ‰€æœ‰ namespace çš„ pods"
    echo ""
    echo "é¡¯ç¤ºæ¬„ä½:"
    echo "  NAME, READY, STATUS, RESTARTS, AGE"
    return 0
  fi
  
  local namespace="${1:-backend}"
  
  if [ "$namespace" = "all" ]; then
    echo "ğŸ“¦ åˆ—å‡ºæ‰€æœ‰ namespace çš„ Pods:"
    echo "----------------------------------------"
    kubectl get pods --all-namespaces
  else
    echo "ğŸ“¦ åˆ—å‡º namespace '${namespace}' çš„æ‰€æœ‰ Pods:"
    echo "----------------------------------------"
    kubectl get pods -n "${namespace}"
  fi
}
